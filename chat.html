<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Claude - Multi-AI v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-100: #f4f4f4;
            --bg-000: #ffffff;
            --bg-200: #e8e8e8;
            --bg-sidebar: #f9f9f9;
            --text-100: #1f1f1f;
            --text-200: #525252;
            --text-300: #737373;
            --text-400: #a3a3a3;
            --text-500: #b8b8b8;
            --text-000: #0a0a0a;
            --border-100: #e5e5e5;
            --border-200: #d4d4d4;
            --border-300: #ebebeb;
            --accent-main: #d97757;
            --accent-hover: #c16843;
            --upgrade-bg: #f5f3f0;
        }

        /* 基础字体系统 - 桌面端默认 */
        html {
            font-size: 16px; /* 桌面端基础字体 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            height: 100vh;
            background-color: var(--bg-100);
            color: var(--text-100);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-100);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* 桌面端：左侧栏隐藏时 - 完全隐藏，只保留切换按钮 */
        @media (min-width: 769px) {
            .sidebar.hidden {
                margin-left: -260px;
                width: 0;
                overflow: hidden;
                flex-shrink: 0;
                flex-basis: 0;
                transition: all 0.3s ease;
            }
            
            /* 主内容区域完全扩展 */
            .sidebar.hidden ~ .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* 内容容器居中 */
            .sidebar.hidden ~ .main-content .chat-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                max-width: 100%;
            }
            
            /* 欢迎区域和消息容器居中 - 收起侧边栏时使用更窄宽度 */
            .sidebar.hidden ~ .main-content .chat-container > .welcome-section,
            .sidebar.hidden ~ .main-content .chat-container > .messages-container {
                max-width: 640px !important;
                width: 100% !important;
                margin: 0 auto !important;
                padding: 2rem !important;
                box-sizing: border-box;
            }
            
            /* input-section也要跟随相同宽度 */
            .sidebar.hidden ~ .main-content .chat-container .input-section {
                max-width: 640px !important;
                margin: 0 auto !important;
            }
            
            /* input-section居中 */
            .sidebar.hidden ~ .main-content .welcome-section .input-section {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 auto !important;
                padding: 0 !important;
                background: transparent !important;
                box-sizing: border-box;
            }
            
            .sidebar.hidden ~ .main-content .input-wrapper {
                width: 100% !important;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* 快捷按钮区域也居中 */
            .sidebar.hidden ~ .main-content .quick-actions {
                max-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box;
            }
            
            /* 切换按钮保持在左上角 */
            .sidebar.hidden ~ .main-content .toggle-sidebar-btn {
                left: 1rem !important;
            }
        }
        
        /* 中屏笔记本：侧边栏隐藏时稍宽 */
        @media (min-width: 1024px) and (max-width: 1439px) {
            .sidebar.hidden ~ .main-content .chat-container > .welcome-section,
            .sidebar.hidden ~ .main-content .chat-container > .messages-container {
                max-width: 720px !important;
                padding: 2.5rem !important;
            }
            
            .sidebar.hidden ~ .main-content .chat-container .input-section {
                max-width: 720px !important;
            }
        }

        /* 大屏：侧边栏隐藏时内容更宽 */
        @media (min-width: 1440px) {
            .sidebar.hidden ~ .main-content .chat-container > .welcome-section,
            .sidebar.hidden ~ .main-content .chat-container > .messages-container {
                max-width: 840px !important;
                padding: 3rem !important;
            }
            
            .sidebar.hidden ~ .main-content .chat-container .input-section {
                max-width: 840px !important;
            }
        }
        
        /* 超大屏：限制最大宽度 */
        @media (min-width: 1920px) {
            .sidebar.hidden ~ .main-content .chat-container > .welcome-section,
            .sidebar.hidden ~ .main-content .chat-container > .messages-container {
                max-width: 900px !important;
                padding: 3rem !important;
            }
            
            .sidebar.hidden ~ .main-content .chat-container .input-section {
                max-width: 900px !important;
            }
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-100);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .logo-text {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.625rem 0.75rem;
            background-color: var(--bg-000);
            border: none;
            border-radius: 0.5rem;
            color: var(--accent-main);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .new-chat-btn:hover {
            background-color: var(--bg-100);
        }

        .new-chat-icon {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: var(--accent-main);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            color: var(--text-200);
            font-size: 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background-color: var(--bg-100);
        }

        .nav-item.active {
            background-color: var(--bg-100);
            font-weight: 500;
        }

        .nav-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .recents-title {
            font-size: 0.75rem;
            color: var(--text-400);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding: 0 0.75rem;
        }

        .recent-item {
            padding: 0.5rem 0.75rem;
            color: var(--text-300);
            font-size: 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-item:hover {
            background-color: var(--bg-100);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-100);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .user-info:hover {
            background-color: var(--bg-100);
        }

        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: #171717;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-100);
        }

        .user-plan {
            font-size: 0.75rem;
            color: var(--text-400);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100vh;
            overflow: hidden; /* 不在这里滚动 */
            min-width: 0; /* 允许flex收缩 */
        }

        .toggle-sidebar-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 2rem;
            height: 2rem;
            border: 1px solid var(--border-200);
            background-color: var(--bg-000);
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .toggle-sidebar-btn:hover {
            background-color: var(--bg-100);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center; /* 内容居中 */
            justify-content: flex-start;
            padding: 0;
            overflow-y: auto; /* 滚动条在chat-container */
            overflow-x: hidden;
            width: 100%;
        }
        
        /* 为聊天内容添加居中wrapper（排除input-section） - 响应式宽度 */
        .chat-container > .welcome-section,
        .chat-container > .messages-container {
            max-width: 100%; /* 默认手机端全宽 */
            width: 100%;
            flex-shrink: 0;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* 平板端：居中显示，左右留白 */
        @media (min-width: 768px) {
            .chat-container > .welcome-section,
            .chat-container > .messages-container {
                max-width: 720px !important; /* 固定宽度，类似Claude官网 */
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        /* 笔记本：稍微宽一些 */
        @media (min-width: 1024px) {
            .chat-container > .welcome-section,
            .chat-container > .messages-container {
                max-width: 800px !important; /* 笔记本上保持舒适宽度 */
                padding-left: 2.5rem;
                padding-right: 2.5rem;
            }
        }

        /* 大屏电脑：限制最大宽度保持可读性 */
        @media (min-width: 1440px) {
            .chat-container > .welcome-section,
            .chat-container > .messages-container {
                max-width: 900px !important; /* 类似Claude官网的宽度 */
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }
        
        /* 超大屏：稍微增加宽度 */
        @media (min-width: 1920px) {
            .chat-container > .welcome-section,
            .chat-container > .messages-container {
                max-width: 1000px !important; /* 超大屏也不要太宽 */
                padding-left: 4rem;
                padding-right: 4rem;
            }
        }
        
        /* 当artifacts打开时，对话区域保持适中宽度 */
        .main-content.with-artifacts .chat-container > .welcome-section,
        .main-content.with-artifacts .chat-container > .messages-container {
            max-width: 95% !important; /* 充分利用剩余空间 */
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
        }
        
        @media (min-width: 1024px) {
            .main-content.with-artifacts .chat-container > .welcome-section,
            .main-content.with-artifacts .chat-container > .messages-container {
                max-width: 90% !important;
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
        }
        
        @media (min-width: 1440px) {
            .main-content.with-artifacts .chat-container > .welcome-section,
            .main-content.with-artifacts .chat-container > .messages-container {
                max-width: 750px !important; /* 限制宽度，确保可读性 */
                padding-left: 2.5rem !important;
                padding-right: 2.5rem !important;
            }
        }
        
        @media (min-width: 1920px) {
            .main-content.with-artifacts .chat-container > .welcome-section,
            .main-content.with-artifacts .chat-container > .messages-container {
                max-width: 850px !important; /* 超大屏适当增加 */
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }
        }

        .welcome-section {
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            min-height: 0;
            gap: 1.5rem;
        }
        
        /* 欢迎界面：input-section应该在welcome-section内 */
        .welcome-section .input-section {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            background: transparent;
        }

        /* 平板及以上增加welcome-section的间距 */
        @media (min-width: 768px) {
            .welcome-section {
                padding: 2.5rem 2rem;
                gap: 2.5rem;
            }
        }
        
        @media (min-width: 1440px) {
            .welcome-section {
                padding: 3rem 2rem;
                gap: 3rem;
            }
        }
        
        /* 确保侧边栏显示时welcome-section居中 */
        .chat-container > .welcome-section {
            margin: 0 auto;
        }
        
        /* 当artifacts打开时的字体优化 - 保持清晰易读 */
        .main-content.with-artifacts .message-text-content {
            font-size: 1rem !important; /* 保持标准大小 */
            line-height: 1.7;
        }
        
        .main-content.with-artifacts .message-text-content h1 {
            font-size: 1.5rem !important;
            margin: 1.25rem 0 0.75rem;
        }
        
        .main-content.with-artifacts .message-text-content h2 {
            font-size: 1.25rem !important;
            margin: 1rem 0 0.625rem;
        }
        
        .main-content.with-artifacts .message-text-content h3 {
            font-size: 1.125rem !important;
            margin: 0.875rem 0 0.5rem;
        }
        
        .main-content.with-artifacts .message-text-content p {
            margin: 0.875rem 0;
        }
        
        .main-content.with-artifacts .message-text-content pre {
            font-size: 0.875rem !important; /* 14px 代码字体 */
            padding: 1rem 1.25rem !important;
            margin: 1rem 0;
        }
        
        .main-content.with-artifacts .message-text-content code {
            font-size: 0.875em !important;
        }
        
        /* 大屏幕时保持一致 */
        @media (min-width: 1600px) {
            .main-content.with-artifacts .message-text-content {
                font-size: 1.0625rem !important; /* 17px */
                line-height: 1.75;
            }
            
            .main-content.with-artifacts .message-text-content h1 {
                font-size: 1.75rem !important;
            }
            
            .main-content.with-artifacts .message-text-content pre {
                font-size: 0.9375rem !important; /* 15px */
            }
        }

        .upgrade-badge {
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.375rem 0.75rem;
            background-color: var(--upgrade-bg);
            border-radius: 1rem;
            font-size: 0.875rem;
            color: var(--text-300);
            margin: 0;
        }

        .upgrade-link {
            color: var(--text-100);
            text-decoration: underline;
            cursor: pointer;
        }

        .welcome-title {
            font-size: 2.25rem;
            font-weight: 400;
            font-family: 'Charter', 'Bitstream Charter', 'Sitka Text', 'Cambria', serif;
            color: var(--text-100);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .claude-icon {
            width: 2rem;
            height: 2rem;
        }

        .input-section {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem 1rem 1rem;
            background-color: var(--bg-100);
        }
        
        /* 响应式输入框宽度 - 与内容区域保持一致，居中显示 */
        @media (min-width: 768px) {
            .input-section {
                max-width: 720px; /* 与对话区域宽度一致 */
                padding: 1rem 2rem 2rem;
            }
        }
        
        @media (min-width: 1024px) {
            .input-section {
                max-width: 800px; /* 与对话区域宽度一致 */
                padding: 1rem 2.5rem 2rem;
            }
        }
        
        @media (min-width: 1440px) {
            .input-section {
                max-width: 900px; /* 与对话区域宽度一致 */
                padding: 1rem 3rem 2rem;
            }
        }
        
        @media (min-width: 1920px) {
            .input-section {
                max-width: 1000px; /* 与对话区域宽度一致 */
                padding: 1rem 4rem 2rem;
            }
        }
        
        /* Artifacts打开时的输入框宽度 - 与对话区域保持一致 */
        .main-content.with-artifacts .input-section {
            max-width: 95% !important;
        }
        
        @media (min-width: 1024px) {
            .main-content.with-artifacts .input-section {
                max-width: 90% !important;
            }
        }
        
        @media (min-width: 1440px) {
            .main-content.with-artifacts .input-section {
                max-width: 750px !important;
            }
        }
        
        @media (min-width: 1920px) {
            .main-content.with-artifacts .input-section {
                max-width: 850px !important;
            }
        }
        
        /* 当 input-section 移出 welcome-section 后，固定在底部 */
        .chat-container > .input-section {
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .input-wrapper {
            background-color: var(--bg-000);
            border: 0.5px solid #d6d6d6;
            border-radius: 1.75rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .input-box {
            width: 100%;
            border: none;
            outline: none;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-100);
            background: transparent;
            resize: none;
            min-height: 1.5rem;
            max-height: 12rem;
        }

        .input-box::placeholder {
            color: var(--text-400);
        }

        .input-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 0.5px solid #ebebeb;
        }

        .model-selector-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-tools {
            display: flex;
            gap: 0.5rem;
        }

        .tool-btn {
            width: 2rem;
            height: 2rem;
            border: none;
            background: transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-400);
            transition: all 0.15s;
        }

        .tool-btn:hover {
            background-color: rgba(0, 0, 0, 0.04);
            color: var(--text-200);
        }

        .model-selector-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            background: transparent;
            border: none;
            font-size: 0.875rem;
            color: var(--text-300);
            cursor: pointer;
            transition: background-color 0.2s;
            transition: background-color 0.15s;
            position: relative;
        }

        .model-selector-btn:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }

        .model-dropdown-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 320px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .model-dropdown-menu.active {
            display: block;
        }

        .model-option-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-100);
        }

        .model-option-item:last-child {
            border-bottom: none;
        }

        .model-option-item:hover {
            background-color: var(--bg-100);
        }

        .model-option-item.selected {
            background-color: var(--bg-100);
        }

        .model-option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .model-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-100);
        }

        .model-description {
            font-size: 0.8125rem;
            color: var(--text-400);
            line-height: 1.4;
        }

        .model-limit {
            font-size: 0.8125rem;
            color: var(--text-400);
            margin-top: 0.25rem;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            color: var(--accent);
            flex-shrink: 0;
        }

        .pro-badge {
            padding: 0.125rem 0.375rem;
            background-color: var(--accent);
            color: white;
            font-size: 0.625rem;
            font-weight: 600;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .model-more-btn {
            padding: 0.875rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-100);
            transition: background-color 0.2s;
        }

        .model-more-btn:hover {
            background-color: var(--bg-100);
        }

        .model-submenu-items {
            background-color: var(--bg-050);
        }

        .model-submenu-items .model-option-item {
            padding-left: 1.5rem;
        }

        .model-dropdown {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 320px;
            display: none;
            z-index: 1000;
        }

        .model-dropdown.active {
            display: block;
        }

        .model-option {
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-300);
        }

        .model-option:first-child {
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .model-option:last-child {
            border-bottom: none;
            border-radius: 0 0 0.75rem 0.75rem;
        }

        .model-option:hover {
            background-color: var(--bg-100);
        }

        .model-option.selected {
            background-color: var(--bg-100);
        }

        .model-option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .model-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-100);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .model-badge {
            font-size: 0.6875rem;
            font-weight: 600;
            color: #6366f1;
            background-color: #eef2ff;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
        }

        .model-checkmark {
            color: var(--accent-main);
            width: 1.25rem;
            height: 1.25rem;
        }

        .model-description {
            font-size: 0.8125rem;
            color: var(--text-400);
            line-height: 1.4;
        }

        .model-limit {
            font-size: 0.75rem;
            color: var(--text-500);
            margin-top: 0.25rem;
        }

        .model-more {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-200);
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .model-more:hover {
            background-color: var(--bg-100);
        }

        .model-submenu {
            background-color: var(--bg-100);
            display: none;
        }

        .model-submenu.active {
            display: block;
        }

        .model-submenu .model-option {
            padding-left: 1.5rem;
            background-color: var(--bg-100);
        }

        .model-submenu .model-option:hover {
            background-color: var(--bg-200);
        }

        /* User menu dropdown */
        .user-menu-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 260px;
            display: none;
            z-index: 1000;
        }

        .user-menu-dropdown.active {
            display: block;
        }

        .user-menu-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-300);
        }

        .user-menu-email {
            font-size: 0.8125rem;
            color: var(--text-400);
            margin-bottom: 0.25rem;
        }

        .user-menu-account {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-menu-account-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-100);
        }

        .checkmark-icon {
            color: var(--accent-main);
            width: 1rem;
            height: 1rem;
        }

        .user-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9375rem;
            color: var(--text-200);
        }

        .user-menu-item:hover {
            background-color: var(--bg-100);
        }

        .user-menu-section {
            border-top: 1px solid var(--border-300);
        }

        .user-menu-item.has-submenu:hover .submenu-arrow {
            transform: translateX(2px);
        }

        .submenu-arrow {
            transition: transform 0.2s;
        }

        .language-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            margin-left: 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 240px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .language-submenu.active {
            display: block;
        }

        .language-option {
            padding: 0.625rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9375rem;
            color: var(--text-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .language-option:hover {
            background-color: var(--bg-100);
        }

        .language-option.selected {
            background-color: var(--bg-100);
        }

        /* Attachment menu */
        .attachment-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .attachment-menu.active {
            display: block;
        }

        .attachment-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9375rem;
            color: var(--text-200);
            border-bottom: 1px solid var(--border-300);
        }

        .attachment-item:last-child {
            border-bottom: none;
        }

        .attachment-item:hover {
            background-color: var(--bg-100);
        }

        .attachment-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--text-300);
        }

        /* 文件附件卡片 */
        .file-attachments-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0 0.75rem;
        }

        .file-card {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.875rem;
            background-color: var(--bg-100);
            border: 1px solid var(--border-200);
            border-radius: 0.5rem;
            max-width: 280px;
            position: relative;
        }

        .file-card-content {
            flex: 1;
            min-width: 0;
        }

        .file-card-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-100);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-card-meta {
            font-size: 0.75rem;
            color: var(--text-400);
            margin-bottom: 0.5rem;
        }

        .file-card-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-300);
            text-transform: uppercase;
        }

        .file-card-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            border: none;
            background-color: transparent;
            color: var(--text-400);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }

        .file-card-remove:hover {
            background-color: var(--bg-200);
            color: var(--text-100);
        }

        .file-card-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }

        /* 消息操作按钮 */
        .message-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-300);
        }

        .message-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border: none;
            background-color: transparent;
            color: var(--text-400);
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
        }

        .message-action-btn:hover {
            background-color: var(--bg-100);
            color: var(--text-200);
        }

        .message-action-btn.active {
            color: var(--accent-main);
            background-color: var(--bg-100);
        }

        .message-action-btn svg {
            width: 1.125rem;
            height: 1.125rem;
        }

        .message-retry-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border: none;
            background-color: transparent;
            color: var(--text-300);
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: auto;
            position: relative;
        }

        .message-retry-btn:hover {
            background-color: var(--bg-100);
            color: var(--text-200);
        }

        .message-retry-btn svg {
            width: 1rem;
            height: 1rem;
        }

        .retry-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.25rem;
            background-color: var(--bg-000);
            border: 1px solid var(--border-200);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.25rem;
            min-width: 180px;
            display: none;
            z-index: 100;
        }

        .retry-dropdown.active {
            display: block;
        }

        .retry-dropdown-item {
            padding: 0.625rem 0.875rem;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: var(--text-200);
            transition: background-color 0.2s;
        }

        .retry-dropdown-item:hover {
            background-color: var(--bg-100);
        }

        .message-disclaimer {
            font-size: 0.75rem;
            color: var(--text-500);
            text-align: center;
            margin-top: 0.75rem;
            padding: 0 2rem;
        }

        /* ==================== 思考链样式 ==================== */
        .thinking-chain {
            margin-bottom: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #f9fafb;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.875rem;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.15s ease;
        }

        .thinking-header:hover {
            background-color: #f3f4f6;
        }

        .thinking-toggle {
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .thinking-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .thinking-label {
            font-size: 0.8125rem;
            font-weight: 500;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .thinking-icon {
            width: 14px;
            height: 14px;
            animation: spin 2s linear infinite;
        }

        .thinking-content {
            padding: 0.875rem;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #4b5563;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-top: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
        }

        .thinking-content.collapsed {
            display: none;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ==================== 正在思考状态 ==================== */
        .thinking-loading {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.875rem 1rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 0.5rem;
            border: 1px solid #bae6fd;
            margin-bottom: 0.5rem;
            animation: fadeIn 0.3s ease-in;
        }

        .thinking-loading-icon {
            width: 18px;
            height: 18px;
            color: #0284c7;
            animation: spin 1.5s linear infinite;
        }

        .thinking-loading-text {
            font-size: 0.875rem;
            color: #0369a1;
            font-weight: 500;
        }

        .thinking-loading-dots {
            display: inline-block;
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ==================== Artifacts 面板 - 完全模仿Claude官网 ==================== */
        .artifacts-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 36%; /* 占36%，类似Claude官网 */
            min-width: 450px; /* 最小宽度 */
            max-width: 600px; /* 最大宽度限制 */
            height: 100vh;
            background-color: #fafaf9;
            border-left: 1px solid #e5e5e5;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 16px rgba(0, 0, 0, 0.08);
        }

        .artifacts-panel.active {
            transform: translateX(0);
        }

        /* 桌面端：Artifacts打开时，主内容区域自适应调整 */
        @media (min-width: 769px) {
            .main-content.with-artifacts {
                margin-right: 32%; /* 为artifacts留出空间 - 减小比例以留更多空间给对话 */
                width: auto !important;
                max-width: 100% !important;
                flex: 1 1 auto !important;
                min-width: 0; /* 允许flex收缩 */
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            /* 当侧边栏隐藏时，对话区域可以更宽 */
            .sidebar.hidden ~ .main-content.with-artifacts {
                margin-left: 0;
                margin-right: 32%;
            }
        }
        
        /* 中等屏幕（笔记本）：占30% */
        @media (min-width: 769px) and (max-width: 1440px) {
            .artifacts-panel {
                width: 30%;
                min-width: 400px;
            }
            
            .main-content.with-artifacts {
                margin-right: 30% !important;
            }
        }
        
        /* 大屏幕：固定宽度 */
        @media (min-width: 1920px) {
            .artifacts-panel {
                width: 580px;
                max-width: 580px;
            }
            
            .main-content.with-artifacts {
                margin-right: 580px !important;
            }
        }
        
        /* 超大屏（4K等） */
        @media (min-width: 2560px) {
            .artifacts-panel {
                width: 600px;
                max-width: 600px;
            }
            
            .main-content.with-artifacts {
                margin-right: 600px !important;
            }
        }

        .artifacts-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8f8f8;
        }

        .artifacts-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #404040;
            flex: 1;
            letter-spacing: -0.005em;
        }

        .artifacts-actions {
            display: flex;
            gap: 0.5rem;
        }

        .artifacts-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            height: 1.875rem;
            border: 1px solid #d4d4d4;
            background-color: transparent;
            color: #525252;
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.8125rem;
            font-weight: 400;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .artifacts-action-btn:hover {
            background-color: #f5f5f5;
            border-color: #a3a3a3;
            color: #171717;
        }

        .artifacts-action-btn svg {
            width: 0.875rem;
            height: 0.875rem;
            stroke-width: 2.5;
        }

        .artifacts-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background-color: #fafaf9;
        }
        
        /* 滚动条样式优化 */
        .artifacts-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .artifacts-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .artifacts-content::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 4px;
        }
        
        .artifacts-content::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }

        .artifacts-edit-panel {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e5e5;
            background-color: #ffffff;
        }

        .artifacts-edit-panel input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e5e5;
            border-radius: 0.5rem;
            background-color: #fafaf9;
            color: #171717;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }

        .artifacts-edit-panel input:focus {
            outline: none;
            border-color: #d97757;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(217, 119, 87, 0.1);
        }
        
        .artifacts-edit-panel input::placeholder {
            color: #a3a3a3;
        }

        .artifacts-code {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            margin: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem; /* 14px - 更清晰的代码字体 */
            line-height: 1.6;
            white-space: pre;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* 在较宽屏幕上增加代码字体 */
        @media (min-width: 1600px) {
            .artifacts-code {
                font-size: 0.9375rem; /* 15px */
                padding: 1.75rem;
            }
        }

        .artifacts-preview {
            width: 100%;
            height: 100%;
            border: 1px solid var(--border-200);
            border-radius: 0.5rem;
            background-color: white;
        }

        .artifacts-markdown {
            line-height: 1.8;
            color: var(--text-100);
        }
        
        /* ==================== Artifacts通知按钮（移动/平板端） ==================== */
        .artifacts-notification-btn {
            position: fixed;
            bottom: 6rem;
            right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, #d97757 0%, #c16843 100%);
            color: white;
            border: none;
            border-radius: 2rem;
            font-size: 0.9375rem;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(217, 119, 87, 0.4);
            cursor: pointer;
            z-index: 199;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideInUp 0.4s ease-out, pulse 2s ease-in-out infinite;
        }
        
        .artifacts-notification-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(217, 119, 87, 0.5);
        }
        
        .artifacts-notification-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .artifacts-notification-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 16px rgba(217, 119, 87, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(217, 119, 87, 0.6);
            }
        }
        
        /* 桌面端不显示通知按钮 */
        @media (min-width: 1025px) {
            .artifacts-notification-btn {
                display: none !important;
            }
        }

        .artifacts-markdown h1,
        .artifacts-markdown h2,
        .artifacts-markdown h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-000);
        }

        .artifacts-markdown code {
            background-color: var(--bg-100);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .artifacts-markdown pre {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        /* ==================== 消息Markdown样式 ==================== */
        .message-text-content {
            line-height: 1.7;
            color: #262626;
        }

        .message-text-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #171717;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 0.5rem;
        }

        .message-text-content h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.625rem;
            color: #171717;
        }

        .message-text-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #262626;
        }

        .message-text-content p {
            margin-bottom: 1rem;
        }

        .message-text-content strong {
            font-weight: 600;
            color: #171717;
        }

        .message-text-content em {
            font-style: italic;
        }

        .message-text-content code {
            background-color: #f3f4f6;
            color: #dc2626;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .message-text-content pre {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem 1.25rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .message-text-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
            font-size: inherit;
        }

        .message-text-content ul,
        .message-text-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .message-text-content li {
            margin-bottom: 0.375rem;
        }

        .message-text-content ul li {
            list-style-type: disc;
        }

        .message-text-content ol li {
            list-style-type: decimal;
        }

        .message-text-content blockquote {
            border-left: 3px solid #d97757;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #525252;
            font-style: italic;
        }

        .message-text-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .message-text-content table th {
            background-color: #f5f5f5;
            font-weight: 600;
            text-align: left;
            padding: 0.625rem 0.875rem;
            border: 1px solid #e5e5e5;
        }

        .message-text-content table td {
            padding: 0.625rem 0.875rem;
            border: 1px solid #e5e5e5;
        }

        .message-text-content table tr:nth-child(even) {
            background-color: #fafaf9;
        }

        .message-text-content hr {
            border: none;
            border-top: 1px solid #e5e5e5;
            margin: 1.5rem 0;
        }

        .message-text-content a {
            color: #d97757;
            text-decoration: none;
        }

        .message-text-content a:hover {
            text-decoration: underline;
        }

        /* 移动端 Artifacts */
        @media (max-width: 768px) {
            .artifacts-panel {
                width: 100% !important;
                z-index: 201;
            }

            .artifacts-panel.active {
                transform: translateX(0);
            }

            .main-content.with-artifacts {
                width: 100% !important;
            }
            
            /* 移动端打开Artifacts时隐藏主内容 */
            body:has(.artifacts-panel.active) .main-content {
                display: none;
            }
            
            /* Artifacts按钮触摸优化 */
            .artifacts-action-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.625rem 1rem;
                font-size: 0.9375rem;
            }
            
            /* Artifacts标题 */
            .artifacts-title {
                font-size: 1rem;
            }
        }

        .send-btn {
            width: 2rem;
            height: 2rem;
            border: none;
            background-color: var(--accent-main);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: var(--accent-hover);
        }

        .quick-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 0;
            padding-top: 2rem;
            padding-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 52rem;
            width: 100%;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.125rem;
            background-color: transparent;
            border: 0.5px solid #d6d6d6;
            border-radius: 2rem;
            font-size: 0.875rem;
            color: var(--text-200);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background-color: var(--bg-000);
            border-color: var(--border-200);
        }

        /* Backdrop overlay for mobile */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-backdrop.active {
            display: block;
            opacity: 1;
        }

        /* ========== 全新响应式设计系统 ========== */
        
        /* 移动端（手机）- 优先设计 */
        @media (max-width: 767px) {
            html {
                font-size: 14px; /* 手机端更紧凑舒适的字体 */
            }
            
            body {
                font-size: 1rem; /* 14px - 舒适的阅读大小 */
                line-height: 1.5; /* 舒适的行高 */
            }
            
            /* 侧边栏 - 默认完全隐藏 */
            .sidebar {
                position: fixed !important;
                z-index: 100 !important;
                height: 100% !important;
                width: 260px !important;
                left: 0 !important;
                top: 0 !important;
                transform: translateX(-100%) !important;
                transition: transform 0.3s ease !important;
                margin-left: 0 !important;
                flex-shrink: 1 !important;
                flex-basis: auto !important;
            }

            /* 只有明确显示时才显示侧边栏 */
            .sidebar.mobile-visible {
                transform: translateX(0) !important;
            }

            .sidebar-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .sidebar-backdrop.active {
                display: block;
            }

            /* 主内容区 */
            .main-content {
                width: 100% !important;
                margin-left: 0 !important;
                max-width: 100% !important;
                position: relative !important;
                z-index: 1 !important;
                flex: 1 1 auto !important;
                min-width: 100% !important;
            }
            
            /* 移动端：禁用桌面端的Artifacts调整 */
            .main-content.with-artifacts {
                width: 100% !important;
                max-width: 100% !important;
                flex: 1 1 auto !important;
            }
            
            /* 切换侧边栏按钮 */
            .toggle-sidebar-btn {
                display: flex !important;
                z-index: 101;
            }

            /* 欢迎界面 - 更紧凑 */
            .welcome-section {
                padding: 1rem 0.875rem !important;
                gap: 1.5rem !important;
            }

            .welcome-title {
                font-size: 1.75rem !important; /* 26px - 手机端舒适大标题 */
                margin-bottom: 0.75rem !important;
            }

            .welcome-description {
                font-size: 1rem !important; /* 15px - 手机端易读 */
                margin-bottom: 1rem !important;
                line-height: 1.5 !important;
            }
            
            /* 消息内容区域 - 更紧凑 */
            .messages-container {
                padding: 0.75rem 0.875rem !important;
            }
            
            /* 消息文本内容 */
            /* 消息内容 - 手机端优化 */
            .message-text-content {
                font-size: 0.95rem !important; /* 13.3px - 手机端舒适阅读 */
                line-height: 1.55 !important;
            }
            
            /* 标题 - 更紧凑 */
            .message-text-content h1 {
                font-size: 1.3rem !important; /* 18.2px */
                margin: 0.875rem 0 0.625rem !important;
                line-height: 1.3 !important;
            }
            
            .message-text-content h2 {
                font-size: 1.15rem !important; /* 16.1px */
                margin: 0.75rem 0 0.5rem !important;
                line-height: 1.3 !important;
            }
            
            .message-text-content h3 {
                font-size: 1.05rem !important; /* 14.7px */
                margin: 0.625rem 0 0.5rem !important;
                line-height: 1.3 !important;
            }
            
            .message-text-content h4 {
                font-size: 1rem !important; /* 14px */
                margin: 0.5rem 0 0.375rem !important;
                line-height: 1.3 !important;
            }
            
            /* 段落 - 减小间距 */
            .message-text-content p {
                margin: 0.5rem 0 !important;
            }
            
            /* 列表 */
            .message-text-content ul,
            .message-text-content ol {
                margin: 0.5rem 0 !important;
                padding-left: 1.25rem !important;
            }
            
            .message-text-content li {
                margin: 0.25rem 0 !important;
                line-height: 1.5 !important;
            }
            
            /* 代码块 - 更紧凑 */
            .message-text-content pre {
                margin: 0.625rem 0 !important;
                padding: 0.75rem !important;
                font-size: 0.8rem !important; /* 11.2px */
                line-height: 1.45 !important;
                overflow-x: auto !important;
                border-radius: 0.375rem !important;
            }
            
            .message-text-content code {
                font-size: 0.85rem !important; /* 11.9px */
                padding: 0.125rem 0.3rem !important;
            }
            
            .message-text-content pre code {
                font-size: 0.8rem !important; /* 11.2px */
            }
            
            /* 引用块 */
            .message-text-content blockquote {
                margin: 0.5rem 0 !important;
                padding-left: 0.75rem !important;
                border-left-width: 2px !important;
            }

            /* 快捷操作按钮 */
            .quick-actions {
                flex-direction: column;
                gap: 0.375rem !important;
            }

            .quick-action-btn {
                width: 100%;
                padding: 0.625rem !important;
                font-size: 0.75rem !important; /* 约9.75px */
            }
            
            /* Artifacts面板 */
            .artifacts-panel {
                font-size: 0.75rem !important;
            }
            
            .artifacts-title {
                font-size: 0.875rem !important; /* 约11.4px */
            }
            
            .artifacts-code {
                font-size: 0.6875rem !important; /* 约9px */
                line-height: 1.3 !important;
            }
            
            /* 按钮文字 */
            button, .btn {
                font-size: 0.75rem !important; /* 约9.75px */
            }
            
            /* 模型选择器 */
            .model-dropdown-btn {
                font-size: 0.75rem !important; /* 约9.75px */
                padding: 0.375rem 0.625rem !important;
            }
            
            .model-name {
                font-size: 0.75rem !important; /* 约9.75px */
            }
            
            .model-description {
                font-size: 0.6875rem !important; /* 约9px */
                line-height: 1.3 !important;
            }

            /* 顶部栏 */
            .top-bar {
                padding: 0.5rem 0.75rem !important;
            }

            .model-selector {
                font-size: 0.75rem !important;
                padding: 0.375rem 0.625rem !important;
            }

            /* 切换侧边栏按钮 */
            .toggle-sidebar-btn {
                z-index: 50;
                width: 32px !important;
                height: 32px !important;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 消息容器（已在上面定义） */
            .message-bubble {
                padding: 0.625rem !important;
                max-width: 90% !important;
            }

            .message-text {
                font-size: 0.8125rem !important; /* 约10.5px */
                line-height: 1.4 !important;
            }

            /* 输入区域 */
            .input-section {
                padding: 0.75rem 1rem 1rem !important;
                padding-bottom: calc(env(safe-area-inset-bottom) + 1rem) !important;
            }

            .input-wrapper {
                padding: 0.75rem !important;
                border-radius: 1.5rem !important;
            }

            .input-box,
            .input-textarea {
                font-size: 16px !important; /* 16px 防止iOS缩放，同时保持易读 */
                min-height: 44px !important;
                max-height: 150px !important;
                line-height: 1.5 !important;
                padding: 0.625rem 0.875rem !important;
            }

            .input-actions {
                padding: 0.5rem !important;
                gap: 0.625rem !important;
            }
            
            /* 发送按钮 - 符合触摸标准 */
            .send-btn {
                width: 44px !important;
                height: 44px !important;
                min-width: 44px !important;
                min-height: 44px !important;
            }
            
            /* 附件按钮等 - 符合触摸标准 */
            .attach-btn, .image-btn, .tool-btn {
                width: 44px !important;
                height: 44px !important;
                min-width: 44px !important;
                min-height: 44px !important;
            }
            
            /* 触摸优化 - Apple 推荐的 44x44pt */
            button, .message-action-btn {
                min-height: 44px !important;
                min-width: 44px !important;
                font-size: 1rem !important;
                padding: 0.625rem 1rem !important;
            }

            /* 附件按钮 */
            .attach-btn {
                width: 36px;
                height: 36px;
            }

            /* 用户信息 */
            .user-info {
                padding: 0.625rem !important;
            }

            .user-details {
                font-size: 0.75rem !important;
            }
            
            .user-name {
                font-size: 0.8125rem !important;
            }
            
            .user-plan {
                font-size: 0.6875rem !important;
            }

            /* 用户菜单下拉框 */
            .user-menu-dropdown {
                width: 280px;
                max-height: 70vh;
                overflow-y: auto;
            }

            /* 语言和Learn more子菜单 */
            .language-submenu,
            .learn-more-submenu {
                width: 240px;
            }

            /* Recents 列表 */
            .recent-item {
                font-size: 0.75rem !important;
                padding: 0.5rem 0.625rem !important;
                line-height: 1.3 !important;
            }
            
            /* 侧边栏标题和文字 */
            .sidebar-header h2 {
                font-size: 0.875rem !important;
            }
            
            .sidebar .btn-text {
                font-size: 0.75rem !important;
            }

            /* 聊天容器 */
            .chat-container {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* 小屏手机适配 (iPhone SE 等) */
        @media (max-width: 375px) {
            html {
                font-size: 12px !important; /* 更小的基础字体 */
            }

            .user-menu-dropdown {
                width: calc(100vw - 2rem);
                left: 1rem;
                right: 1rem;
            }

            .language-submenu,
            .learn-more-submenu {
                width: calc(100vw - 2rem);
            }
        }

        /* 横屏模式优化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .welcome-section {
                padding: 0.75rem;
            }

            .welcome-title {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .quick-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .quick-action-btn {
                width: calc(50% - 0.25rem);
            }

            .messages-container {
                padding: 0.75rem !important;
            }

            .input-section {
                padding: 0.5rem 1rem;
            }
        }

        /* ========== 平板端（iPad等）========== */
        @media (min-width: 768px) and (max-width: 1023px) {
            html {
                font-size: 15px; /* 平板端字体 */
            }
            
            /* 侧边栏正常显示 */
            .sidebar {
                width: 260px;
                position: relative;
            }
            
            /* 消息文本 */
            .message-text-content {
                font-size: 1rem; /* 15px */
                line-height: 1.6;
            }
            
            /* 标题大小 */
            .message-text-content h1 {
                font-size: 1.6rem; /* 24px */
            }
            
            .message-text-content h2 {
                font-size: 1.4rem; /* 21px */
            }
            
            /* 输入框 */
            .input-box {
                font-size: 16px;
                min-height: 48px;
            }
            
            /* 按钮 */
            button, .send-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* ========== 笔记本（13-15寸）========== */
        @media (min-width: 1024px) and (max-width: 1439px) {
            html {
                font-size: 16px; /* 标准桌面字体 */
            }
            
            /* 侧边栏 */
            .sidebar {
                width: 260px;
            }
            
            /* 消息文本 */
            .message-text-content {
                font-size: 1rem; /* 16px */
                line-height: 1.7;
            }
            
            /* 标题 */
            .message-text-content h1 {
                font-size: 1.75rem; /* 28px */
                margin: 1.25rem 0 0.875rem;
            }
            
            .message-text-content h2 {
                font-size: 1.5rem; /* 24px */
                margin: 1rem 0 0.75rem;
            }
            
            .message-text-content h3 {
                font-size: 1.25rem; /* 20px */
            }
            
            /* 输入框 */
            .input-box {
                font-size: 16px;
                min-height: 48px;
                padding: 0.75rem 1rem;
            }
            
            /* 按钮 - 鼠标操作可以更小 */
            button {
                min-height: 36px;
                min-width: 36px;
            }
            
            .send-btn {
                width: 40px;
                height: 40px;
            }
        }

        /* ========== 大屏桌面（>=1440px）========== */
        @media (min-width: 1440px) {
            html {
                font-size: 16px;
            }
            
            /* 侧边栏更宽 */
            .sidebar {
                width: 280px;
            }
            
            /* 消息文本 */
            .message-text-content {
                font-size: 1.0625rem; /* 17px - 大屏更舒适 */
                line-height: 1.75;
            }
            
            /* 标题更大气 */
            .message-text-content h1 {
                font-size: 2rem; /* 32px */
                margin: 1.5rem 0 1rem;
            }
            
            .message-text-content h2 {
                font-size: 1.625rem; /* 26px */
                margin: 1.25rem 0 0.875rem;
            }
            
            .message-text-content h3 {
                font-size: 1.375rem; /* 22px */
                margin: 1rem 0 0.75rem;
            }
            
            /* 段落间距更宽松 */
            .message-text-content p {
                margin: 1rem 0;
            }
            
            /* 输入框 */
            .input-box {
                font-size: 17px;
                min-height: 52px;
                padding: 0.875rem 1.25rem;
            }
            
            /* 按钮 */
            .send-btn {
                width: 42px;
                height: 42px;
            }
            
            /* 欢迎标题 */
            .welcome-title {
                font-size: 2.5rem; /* 40px */
            }
            
            .welcome-description {
                font-size: 1.125rem; /* 18px */
            }
        }

        /* ========== 超大屏（>=1920px）========== */
        @media (min-width: 1920px) {
            html {
                font-size: 17px; /* 超大屏稍微放大字体 */
            }
            
            .sidebar {
                width: 300px;
            }
            
            .message-text-content {
                font-size: 1.125rem; /* 19px */
                line-height: 1.8;
            }
            
            .message-text-content h1 {
                font-size: 2.25rem; /* 38px */
            }
            
            .message-text-content h2 {
                font-size: 1.875rem; /* 32px */
            }
        }
    </style>
    <link rel="stylesheet" href="responsive-fixes.css">
    <link rel="stylesheet" href="mobile-优化.css">
</head>
<body>
    <!-- Sidebar Backdrop (for mobile) -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-section">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="#D97757">
                    <path d="M11.376 24L10.776 23.544L10.44 22.8L10.776 21.312L11.16 19.392L11.472 17.856L11.76 15.96L11.928 15.336L11.904 15.288L11.784 15.312L10.344 17.28L8.16 20.232L6.432 22.056L6.024 22.224L5.304 21.864L5.376 21.192L5.784 20.616L8.16 17.568L9.6 15.672L10.536 14.592L10.512 14.448H10.464L4.128 18.576L3 18.72L2.496 18.264L2.568 17.52L2.808 17.28L4.704 15.96L9.432 13.32L9.504 13.08L9.432 12.96H9.192L8.4 12.912L5.712 12.84L3.384 12.744L1.104 12.624L0.528 12.504L0 11.784L0.048 11.424L0.528 11.112L1.224 11.16L2.736 11.28L5.016 11.424L6.672 11.52L9.12 11.784H9.504L9.552 11.616L9.432 11.52L9.336 11.424L6.96 9.84L4.416 8.16L3.072 7.176L2.352 6.672L1.992 6.216L1.848 5.208L2.496 4.488L3.384 4.56L3.6 4.608L4.488 5.304L6.384 6.768L8.88 8.616L9.24 8.904L9.408 8.808V8.736L9.24 8.472L7.896 6.024L6.456 3.528L5.808 2.496L5.64 1.872C5.576 1.656 5.544 1.416 5.544 1.152L6.288 0.144001L6.696 0L7.704 0.144001L8.112 0.504001L8.736 1.92L9.72 4.152L11.28 7.176L11.736 8.088L11.976 8.904L12.072 9.168H12.24V9.024L12.36 7.296L12.6 5.208L12.84 2.52L12.912 1.752L13.296 0.840001L14.04 0.360001L14.616 0.624001L15.096 1.32L15.024 1.752L14.76 3.6L14.184 6.504L13.824 8.472H14.04L14.28 8.208L15.264 6.912L16.92 4.848L17.64 4.032L18.504 3.12L19.056 2.688H20.088L20.832 3.816L20.496 4.992L19.44 6.336L18.552 7.464L17.28 9.168L16.512 10.536L16.584 10.632H16.752L19.608 10.008L21.168 9.744L22.992 9.432L23.832 9.816L23.928 10.2L23.592 11.016L21.624 11.496L19.32 11.952L15.888 12.768L15.84 12.792L15.888 12.864L17.424 13.008L18.096 13.056H19.728L22.752 13.272L23.544 13.8L24 14.424L23.928 14.928L22.704 15.528L21.072 15.144L17.232 14.232L15.936 13.92H15.744V14.016L16.848 15.096L18.84 16.896L21.36 19.224L21.48 19.8L21.168 20.28L20.832 20.232L18.624 18.552L17.76 17.808L15.84 16.2H15.72V16.368L16.152 17.016L18.504 20.544L18.624 21.624L18.456 21.96L17.832 22.176L17.184 22.056L15.792 20.136L14.376 17.952L13.224 16.008L13.104 16.104L12.408 23.352L12.096 23.712L11.376 24Z"></path>
                </svg>
                <span class="logo-text" data-i18n="logoText">Claude</span>
            </div>
            <button class="new-chat-btn" id="newChatBtn" data-i18n="newChat">
                <span class="new-chat-icon">+</span>
                New chat
            </button>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-item active" data-i18n="chats">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Chats
                </div>
                <div class="nav-item" data-i18n="projects">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Projects
                </div>
                <div class="nav-item" data-i18n="artifacts">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Artifacts
                </div>
            </div>

            <div class="nav-section">
                <div class="recents-title" data-i18n="recents">Recents</div>
                <div id="recentsList">
                    <!-- Recent conversations will be dynamically added here -->
                </div>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info" id="userInfo">
                <div class="user-avatar">Y</div>
                <div class="user-details">
                    <div class="user-name">yuqingwei</div>
                    <div class="user-plan" data-i18n="freePlan">Free plan</div>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                
                <!-- User Menu Dropdown -->
                <div class="user-menu-dropdown" id="userMenuDropdown">
                    <div class="user-menu-header">
                        <div class="user-menu-email">ywj2333333434@outlook.com</div>
                        <div class="user-menu-account">
                            <span class="user-menu-account-name" data-i18n="personal">Personal</span>
                            <svg class="checkmark-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="user-plan" data-i18n="freePlan">Free plan</div>
                    </div>
                    
                    <div class="user-menu-item" data-i18n="settings">
                        Settings
                        <span style="font-size: 0.75rem; color: var(--text-400);">⌘+Ctrl+,</span>
                    </div>
                    
                    <div class="user-menu-item has-submenu" id="languageMenuItem" style="position: relative;" data-i18n="language">
                        Language
                        <svg class="submenu-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        
                        <!-- Language Submenu -->
                        <div class="language-submenu" id="languageSubmenu">
                            <div class="language-option selected">
                                English (United States)
                                <svg class="checkmark-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="language-option">简体中文 (中国)</div>
                            <div class="language-option">Français (France)</div>
                            <div class="language-option">Deutsch (Deutschland)</div>
                            <div class="language-option">हिंदी (भारत)</div>
                            <div class="language-option">Indonesia (Indonesia)</div>
                            <div class="language-option">Italiano (Italia)</div>
                            <div class="language-option">日本語 (日本)</div>
                            <div class="language-option">한국어(대한민국)</div>
                            <div class="language-option">Português (Brasil)</div>
                            <div class="language-option">Español (Latinoamérica)</div>
                            <div class="language-option">Español (España)</div>
                        </div>
                    </div>
                    
                    <div class="user-menu-item" data-i18n="getHelp">Get help</div>
                    
                    <div class="user-menu-section">
                        <div class="user-menu-item" data-i18n="upgradePlan" onclick="alert('这是一个自建的Claude UI，无需付费升级！\n\n✅ 已配置：Kimi AI（免费使用）\n✅ 支持：配置自己的API Key\n✅ 功能：与官方Claude界面一致');">Upgrade plan</div>
                        <div class="user-menu-item has-submenu" id="learnMoreMenuItem" style="position: relative;" data-i18n="learnMore">
                            Learn more
                            <svg class="submenu-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            
                            <!-- Learn More Submenu -->
                            <div class="language-submenu" id="learnMoreSubmenu">
                                <div class="language-option" style="justify-content: space-between;" data-i18n="aboutAnthropic">
                                    About Anthropic
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                                <div class="language-option" style="justify-content: space-between;" data-i18n="usagePolicy">
                                    Usage policy
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                                <div class="language-option" style="justify-content: space-between;" data-i18n="privacyPolicy">
                                    Privacy policy
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                                <div class="language-option" data-i18n="privacyChoices">Your privacy choices</div>
                                <div class="language-option" style="justify-content: space-between;" data-i18n="keyboardShortcuts">
                                    Keyboard shortcuts
                                    <span style="font-size: 0.75rem; color: var(--text-400);">Ctrl+?</span>
                                </div>
                            </div>
                        </div>
                        <div class="user-menu-item" data-i18n="logOut">Log out</div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <button class="toggle-sidebar-btn" id="toggleSidebar" title="Toggle sidebar Ctrl+.">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
        </button>
        
        <!-- Top right notification icon -->
        <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
            <button style="width: 2.5rem; height: 2.5rem; border: none; background: transparent; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-300); transition: background-color 0.15s; position: relative;" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.04)'" onmouseout="this.style.backgroundColor='transparent'" title="Notifications">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <!-- Notification badge -->
                <span style="position: absolute; top: 0.5rem; right: 0.5rem; width: 0.5rem; height: 0.5rem; background-color: #ef4444; border-radius: 50%; border: 2px solid var(--bg-100);"></span>
            </button>
        </div>

        <div class="chat-container">
            <div class="welcome-section">
                <div class="upgrade-badge">
                    <span>Free plan</span>
                    <span>·</span>
                    <span class="upgrade-link" onclick="event.preventDefault(); alert('这是一个自建的Claude UI，无需付费升级！\n您可以免费使用 Kimi AI 或配置自己的API Key。');" style="cursor: pointer;">Upgrade</span>
                </div>

                <h1 class="welcome-title" data-i18n="welcomeTitle" id="welcomeTitle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="claude-icon" fill="#D97757">
                        <path d="M11.376 24L10.776 23.544L10.44 22.8L10.776 21.312L11.16 19.392L11.472 17.856L11.76 15.96L11.928 15.336L11.904 15.288L11.784 15.312L10.344 17.28L8.16 20.232L6.432 22.056L6.024 22.224L5.304 21.864L5.376 21.192L5.784 20.616L8.16 17.568L9.6 15.672L10.536 14.592L10.512 14.448H10.464L4.128 18.576L3 18.72L2.496 18.264L2.568 17.52L2.808 17.28L4.704 15.96L9.432 13.32L9.504 13.08L9.432 12.96H9.192L8.4 12.912L5.712 12.84L3.384 12.744L1.104 12.624L0.528 12.504L0 11.784L0.048 11.424L0.528 11.112L1.224 11.16L2.736 11.28L5.016 11.424L6.672 11.52L9.12 11.784H9.504L9.552 11.616L9.432 11.52L9.336 11.424L6.96 9.84L4.416 8.16L3.072 7.176L2.352 6.672L1.992 6.216L1.848 5.208L2.496 4.488L3.384 4.56L3.6 4.608L4.488 5.304L6.384 6.768L8.88 8.616L9.24 8.904L9.408 8.808V8.736L9.24 8.472L7.896 6.024L6.456 3.528L5.808 2.496L5.64 1.872C5.576 1.656 5.544 1.416 5.544 1.152L6.288 0.144001L6.696 0L7.704 0.144001L8.112 0.504001L8.736 1.92L9.72 4.152L11.28 7.176L11.736 8.088L11.976 8.904L12.072 9.168H12.24V9.024L12.36 7.296L12.6 5.208L12.84 2.52L12.912 1.752L13.296 0.840001L14.04 0.360001L14.616 0.624001L15.096 1.32L15.024 1.752L14.76 3.6L14.184 6.504L13.824 8.472H14.04L14.28 8.208L15.264 6.912L16.92 4.848L17.64 4.032L18.504 3.12L19.056 2.688H20.088L20.832 3.816L20.496 4.992L19.44 6.336L18.552 7.464L17.28 9.168L16.512 10.536L16.584 10.632H16.752L19.608 10.008L21.168 9.744L22.992 9.432L23.832 9.816L23.928 10.2L23.592 11.016L21.624 11.496L19.32 11.952L15.888 12.768L15.84 12.792L15.888 12.864L17.424 13.008L18.096 13.056H19.728L22.752 13.272L23.544 13.8L24 14.424L23.928 14.928L22.704 15.528L21.072 15.144L17.232 14.232L15.936 13.92H15.744V14.016L16.848 15.096L18.84 16.896L21.36 19.224L21.48 19.8L21.168 20.28L20.832 20.232L18.624 18.552L17.76 17.808L15.84 16.2H15.72V16.368L16.152 17.016L18.504 20.544L18.624 21.624L18.456 21.96L17.832 22.176L17.184 22.056L15.792 20.136L14.376 17.952L13.224 16.008L13.104 16.104L12.408 23.352L12.096 23.712L11.376 24Z"></path>
                    </svg>
                    <!-- 问候语将由 JavaScript 动态设置 -->
                </h1>

                <!-- Input Section -->
                <div class="input-section">
                <div class="input-wrapper">
                    <!-- 文件附件显示区域 -->
                    <div class="file-attachments-container" id="fileAttachmentsContainer"></div>
                    
                    <textarea class="input-box" data-i18n="inputPlaceholder" placeholder="How can I help you today?" rows="1"></textarea>
                    <div class="input-actions">
                        <div class="input-tools">
                            <button class="tool-btn" id="attachBtn" title="Attach files" style="position: relative;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                
                                <!-- 隐藏的文件输入 -->
                                <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.txt,.doc,.docx,.csv,.json,.xml,.md" multiple>
                                
                                <!-- Attachment Menu -->
                                <div class="attachment-menu" id="attachmentMenu">
                                    <div class="attachment-item" id="uploadFileBtn">
                                        <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                        </svg>
                                        Upload a file
                                    </div>
                                    <div class="attachment-item">
                                        <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        Take a screenshot
                                    </div>
                                    <div class="attachment-item">
                                        <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
                                        </svg>
                                        Add from GitHub
                                    </div>
                                    <div class="attachment-item">
                                        <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        Use a project
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </button>
                            <button class="tool-btn" title="Random prompt">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v6m0 12v6M4.93 4.93l4.24 4.24m5.66 5.66l4.24 4.24M2 12h6m12 0h6M4.93 19.07l4.24-4.24m5.66-5.66l4.24-4.24"></path>
                                </svg>
                            </button>
                            <button class="tool-btn" title="Add time context">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </button>
                        </div>
                        <div class="model-selector-wrapper" style="position: relative;">
                            <button class="model-selector-btn" id="modelSelectorBtn">
                                <span id="selectedModelText">Sonnet 4.5</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            
                            <!-- Model Dropdown Menu -->
                            <div class="model-dropdown-menu" id="modelDropdownMenu">
                                <div class="model-option-item selected" data-model="sonnet-4.5">
                                    <div class="model-option-header">
                                        <span class="model-name">Sonnet 4.5</span>
                                        <svg class="checkmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <div class="model-description">Smartest model. Efficient for everyday use.</div>
                                </div>
                                
                                <div class="model-option-item" data-model="opus-4.1">
                                    <div class="model-option-header">
                                        <span class="model-name">Opus 4.1</span>
                                    </div>
                                    <div class="model-description">Powerful, large model for complex challenges</div>
                                    <div class="model-limit">3 remaining until Oct 6</div>
                                </div>
                                
                                <div class="model-more-btn" id="moreModelsBtn">
                                    <span>More models</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                                
                                <!-- Submenu -->
                                <div class="model-submenu-items" id="moreModelsSubmenu" style="display: none;">
                                    <div class="model-option-item" data-model="gemini-2.5-pro">
                                        <div class="model-option-header">
                                            <span class="model-name">💎 Gemini 2.5 Pro</span>
                                        </div>
                                        <div class="model-description">Google's latest & most advanced AI</div>
                                    </div>
                                    <div class="model-option-item" data-model="kimi">
                                        <div class="model-option-header">
                                            <span class="model-name">🌙 Kimi AI</span>
                                        </div>
                                        <div class="model-description">月之暗面 - 200k 超长文本处理</div>
                                    </div>
                                    <div class="model-option-item" data-model="opus-4">
                                        <div class="model-option-header">
                                            <span class="model-name">Opus 4</span>
                                        </div>
                                        <div class="model-limit">3 remaining until Oct 6</div>
                                    </div>
                                    <div class="model-option-item" data-model="sonnet-4">
                                        <div class="model-option-header">
                                            <span class="model-name">Sonnet 4</span>
                                        </div>
                                    </div>
                                    <div class="model-option-item" data-model="sonnet-3.7">
                                        <div class="model-option-header">
                                            <span class="model-name">Sonnet 3.7</span>
                                            <span class="pro-badge">PRO</span>
                                        </div>
                                    </div>
                                    <div class="model-option-item" data-model="opus-3">
                                        <div class="model-option-header">
                                            <span class="model-name">Opus 3</span>
                                            <span class="pro-badge">PRO</span>
                                        </div>
                                    </div>
                                    <div class="model-option-item" data-model="haiku-3.5">
                                        <div class="model-option-header">
                                            <span class="model-name">Haiku 3.5</span>
                                            <span class="pro-badge">PRO</span>
                                        </div>
                                        <div class="model-description">Fastest model for daily tasks</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="send-btn" id="sendBtn" title="Send message">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions - 在输入框下方 -->
            <div class="quick-actions">
                        <button class="quick-action-btn" data-i18n="code">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="16 18 22 12 16 6"></polyline>
                                <polyline points="8 6 2 12 8 18"></polyline>
                            </svg>
                            Code
                        </button>
                        <button class="quick-action-btn" data-i18n="write">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            Write
                        </button>
                        <button class="quick-action-btn" data-i18n="learn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            Learn
                        </button>
                        <button class="quick-action-btn" data-i18n="lifeStuff">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            Life stuff
                        </button>
                        <button class="quick-action-btn" data-i18n="claudeChoice">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Claude's choice
                        </button>
                    </div>
            </div>
        </div>
    </main>

    <!-- Artifacts 面板 -->
    <div class="artifacts-panel" id="artifactsPanel">
        <div class="artifacts-header">
            <div class="artifacts-title" id="artifactsTitle">Artifact</div>
            <div class="artifacts-actions">
                <button class="artifacts-action-btn" id="copyArtifactsBtn" title="Copy code">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy
                </button>
                <button class="artifacts-action-btn" id="closeArtifactsBtn" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="artifacts-content" id="artifactsContent">
            <!-- Artifacts 内容将动态加载到这里 -->
        </div>
        <div class="artifacts-edit-panel" id="artifactsEditPanel" style="display: none;">
            <input type="text" id="artifactsEditInput" placeholder="告诉 AI 如何修改这段代码...（按 Enter 发送）" />
        </div>
    </div>

    <!-- Markdown渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <script>
        // ==================== 设备检测系统 ====================
        const DeviceDetector = {
            // 设备信息
            device: {
                type: 'desktop', // desktop, tablet, mobile
                os: 'unknown',   // ios, android, windows, macos, linux
                browser: 'unknown', // chrome, safari, firefox, edge
                touch: false,    // 是否支持触摸
                screenSize: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            },
            
            // 初始化检测
            init() {
                this.detectDevice();
                this.detectOS();
                this.detectBrowser();
                this.detectTouch();
                this.logDeviceInfo();
                this.setupResizeListener();
                return this.device;
            },
            
            // 检测设备类型
            detectDevice() {
                const ua = navigator.userAgent.toLowerCase();
                const width = window.innerWidth;
                
                // 优先检测User Agent
                if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                    this.device.type = 'tablet';
                } else if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                    this.device.type = 'mobile';
                } else {
                    // 根据屏幕宽度辅助判断
                    if (width <= 768) {
                        this.device.type = 'mobile';
                    } else if (width > 768 && width <= 1024) {
                        this.device.type = 'tablet';
                    } else {
                        this.device.type = 'desktop';
                    }
                }
                
                // 添加设备类型到body
                document.body.setAttribute('data-device-type', this.device.type);
            },
            
            // 检测操作系统
            detectOS() {
                const ua = navigator.userAgent;
                const platform = navigator.platform.toLowerCase();
                
                if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) {
                    this.device.os = 'ios';
                } else if (/android/i.test(ua)) {
                    this.device.os = 'android';
                } else if (/Win/i.test(platform)) {
                    this.device.os = 'windows';
                } else if (/Mac/i.test(platform)) {
                    this.device.os = 'macos';
                } else if (/Linux/i.test(platform)) {
                    this.device.os = 'linux';
                }
                
                document.body.setAttribute('data-os', this.device.os);
            },
            
            // 检测浏览器
            detectBrowser() {
                const ua = navigator.userAgent.toLowerCase();
                
                if (ua.indexOf('edg') > -1) {
                    this.device.browser = 'edge';
                } else if (ua.indexOf('chrome') > -1 && ua.indexOf('edg') === -1) {
                    this.device.browser = 'chrome';
                } else if (ua.indexOf('safari') > -1 && ua.indexOf('chrome') === -1) {
                    this.device.browser = 'safari';
                } else if (ua.indexOf('firefox') > -1) {
                    this.device.browser = 'firefox';
                }
                
                document.body.setAttribute('data-browser', this.device.browser);
            },
            
            // 检测触摸支持
            detectTouch() {
                this.device.touch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                document.body.setAttribute('data-touch', this.device.touch);
            },
            
            // 监听窗口大小变化
            setupResizeListener() {
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        const oldType = this.device.type;
                        this.device.screenSize = {
                            width: window.innerWidth,
                            height: window.innerHeight
                        };
                        this.detectDevice();
                        
                        // 设备类型变化时触发自定义事件
                        if (oldType !== this.device.type) {
                            window.dispatchEvent(new CustomEvent('deviceTypeChanged', {
                                detail: {
                                    oldType: oldType,
                                    newType: this.device.type
                                }
                            }));
                        }
                    }, 200);
                });
            },
            
            // 打印设备信息
            logDeviceInfo() {
                console.log('📱 设备信息检测：');
                console.log('  设备类型:', this.device.type);
                console.log('  操作系统:', this.device.os);
                console.log('  浏览器:', this.device.browser);
                console.log('  触摸支持:', this.device.touch ? '是' : '否');
                console.log('  屏幕尺寸:', `${this.device.screenSize.width}x${this.device.screenSize.height}`);
                console.log('  User Agent:', navigator.userAgent);
            },
            
            // 便捷方法
            isMobile() {
                return this.device.type === 'mobile';
            },
            
            isTablet() {
                return this.device.type === 'tablet';
            },
            
            isDesktop() {
                return this.device.type === 'desktop';
            },
            
            isMobileOrTablet() {
                return this.device.type === 'mobile' || this.device.type === 'tablet';
            },
            
            isIOS() {
                return this.device.os === 'ios';
            },
            
            isAndroid() {
                return this.device.os === 'android';
            },
            
            supportTouch() {
                return this.device.touch;
            }
        };
        
        // 初始化设备检测
        const deviceInfo = DeviceDetector.init();
        
        // 将DeviceDetector暴露为全局对象，方便其他代码使用
        window.DeviceDetector = DeviceDetector;
        
        // ==================== 思考链处理 ====================
        function updateMessageWithThinking(textElement, fullMessage, provider) {
            // 只对 Gemini 显示思考链
            if (provider !== 'gemini') {
                // 使用Markdown渲染AI回复
                if (typeof marked !== 'undefined') {
                    textElement.innerHTML = '';
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-text-content';
                    contentDiv.innerHTML = marked.parse(fullMessage);
                    textElement.appendChild(contentDiv);
                    // 保存原始Markdown文本用于复制
                    textElement.setAttribute('data-original-markdown', fullMessage);
                } else {
                    textElement.textContent = fullMessage;
                }
                return;
            }

            // 检查是否包含思考标记
            const thinkingRegex = /<thinking>([\s\S]*?)<\/thinking>/;
            const answerRegex = /<answer>([\s\S]*?)<\/answer>/;
            
            const thinkingMatch = fullMessage.match(thinkingRegex);
            const answerMatch = fullMessage.match(answerRegex);

            if (thinkingMatch || answerMatch) {
                textElement.innerHTML = '';

                // 添加思考链
                if (thinkingMatch) {
                    const thinkingText = thinkingMatch[1].trim();
                    const thinkingChain = document.createElement('div');
                    thinkingChain.className = 'thinking-chain';
                    
                    const thinkingHeader = document.createElement('div');
                    thinkingHeader.className = 'thinking-header';
                    thinkingHeader.innerHTML = `
                        <svg class="thinking-toggle collapsed" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        <span class="thinking-label">
                            <svg class="thinking-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            思考过程
                        </span>
                    `;
                    
                    const thinkingContent = document.createElement('div');
                    thinkingContent.className = 'thinking-content collapsed';
                    thinkingContent.textContent = thinkingText;
                    
                    // 添加点击切换
                    thinkingHeader.addEventListener('click', () => {
                        const toggle = thinkingHeader.querySelector('.thinking-toggle');
                        const content = thinkingContent;
                        toggle.classList.toggle('collapsed');
                        content.classList.toggle('collapsed');
                    });
                    
                    thinkingChain.appendChild(thinkingHeader);
                    thinkingChain.appendChild(thinkingContent);
                    textElement.appendChild(thinkingChain);
                }

                // 添加回答部分（使用Markdown渲染）
                if (answerMatch) {
                    const answerText = answerMatch[1].trim();
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'message-text-content';
                    if (typeof marked !== 'undefined') {
                        answerDiv.innerHTML = marked.parse(answerText);
                    } else {
                        answerDiv.style.whiteSpace = 'pre-wrap';
                        answerDiv.style.wordWrap = 'break-word';
                        answerDiv.textContent = answerText;
                    }
                    textElement.appendChild(answerDiv);
                } else if (!thinkingMatch) {
                    // 如果没有找到任何标记，使用Markdown显示原始内容
                    if (typeof marked !== 'undefined') {
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'message-text-content';
                        contentDiv.innerHTML = marked.parse(fullMessage);
                        textElement.innerHTML = '';
                        textElement.appendChild(contentDiv);
                        textElement.setAttribute('data-original-markdown', fullMessage);
                    } else {
                        textElement.textContent = fullMessage;
                    }
                }
            } else {
                // 没有思考标记，使用Markdown直接显示
                if (typeof marked !== 'undefined') {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-text-content';
                    contentDiv.innerHTML = marked.parse(fullMessage);
                    textElement.innerHTML = '';
                    textElement.appendChild(contentDiv);
                    textElement.setAttribute('data-original-markdown', fullMessage);
                } else {
                    textElement.textContent = fullMessage;
                }
            }
        }

        // ==================== 获取时间问候语 ====================
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) {
                return 'morning';
            } else if (hour >= 12 && hour < 18) {
                return 'afternoon';
            } else {
                return 'evening';
            }
        }

        function getGreetingText(language = 'en') {
            const greeting = getGreeting();
            const greetings = {
                'en': {
                    'morning': 'Good morning',
                    'afternoon': 'Good afternoon',
                    'evening': 'Good evening'
                },
                'zh': {
                    'morning': '早上好',
                    'afternoon': '下午好',
                    'evening': '晚上好'
                },
                'fr': {
                    'morning': 'Bonjour',
                    'afternoon': 'Bon après-midi',
                    'evening': 'Bonsoir'
                },
                'de': {
                    'morning': 'Guten Morgen',
                    'afternoon': 'Guten Nachmittag',
                    'evening': 'Guten Abend'
                },
                'es': {
                    'morning': 'Buenos días',
                    'afternoon': 'Buenas tardes',
                    'evening': 'Buenas noches'
                },
                'ja': {
                    'morning': 'おはようございます',
                    'afternoon': 'こんにちは',
                    'evening': 'こんばんは'
                }
            };
            return greetings[language][greeting];
        }

        // ==================== 多语言支持 ====================
        const translations = {
            'en': {
                logoText: 'Claude',
                newChat: 'New chat',
                chats: 'Chats',
                projects: 'Projects',
                artifacts: 'Artifacts',
                recents: 'Recents',
                personal: 'Personal',
                freePlan: 'Free plan',
                settings: 'Settings',
                language: 'Language',
                getHelp: 'Get help',
                upgradePlan: 'Upgrade plan',
                learnMore: 'Learn more',
                logOut: 'Log out',
                welcomeTitle: `${getGreetingText('en')}, yuqingwei`,
                inputPlaceholder: 'How can I help you today?',
                code: 'Code',
                write: 'Write',
                learn: 'Learn',
                lifeStuff: 'Life stuff',
                claudeChoice: "Claude's choice",
                aboutAnthropic: 'About Anthropic',
                usagePolicy: 'Usage policy',
                privacyPolicy: 'Privacy policy',
                privacyChoices: 'Your privacy choices',
                keyboardShortcuts: 'Keyboard shortcuts',
                upgrade: 'Upgrade',
                uploadFile: 'Upload a file',
                takeScreenshot: 'Take a screenshot',
                addFromGithub: 'Add from GitHub',
                useProject: 'Use a project'
            },
            'zh': {
                logoText: 'Claude',
                newChat: '新建对话',
                chats: '对话',
                projects: '项目',
                artifacts: '作品',
                recents: '最近',
                personal: '个人',
                freePlan: '免费计划',
                settings: '设置',
                language: '语言',
                getHelp: '获取帮助',
                upgradePlan: '升级计划',
                learnMore: '了解更多',
                logOut: '退出登录',
                welcomeTitle: `${getGreetingText('zh')}，yuqingwei`,
                inputPlaceholder: '我能帮你什么？',
                code: '编程',
                write: '写作',
                learn: '学习',
                lifeStuff: '生活',
                claudeChoice: 'Claude 推荐',
                aboutAnthropic: '关于 Anthropic',
                usagePolicy: '使用政策',
                privacyPolicy: '隐私政策',
                privacyChoices: '您的隐私选择',
                keyboardShortcuts: '键盘快捷键',
                upgrade: '升级',
                uploadFile: '上传文件',
                takeScreenshot: '截图',
                addFromGithub: '从 GitHub 添加',
                useProject: '使用项目'
            },
            'fr': {
                logoText: 'Claude',
                newChat: 'Nouvelle discussion',
                chats: 'Discussions',
                projects: 'Projets',
                artifacts: 'Artefacts',
                recents: 'Récents',
                personal: 'Personnel',
                freePlan: 'Plan gratuit',
                settings: 'Paramètres',
                language: 'Langue',
                getHelp: 'Obtenir de l\'aide',
                upgradePlan: 'Améliorer le plan',
                learnMore: 'En savoir plus',
                logOut: 'Se déconnecter',
                welcomeTitle: `${getGreetingText('fr')}, yuqingwei`,
                inputPlaceholder: 'Comment puis-je vous aider aujourd\'hui ?',
                code: 'Code',
                write: 'Écrire',
                learn: 'Apprendre',
                lifeStuff: 'Vie quotidienne',
                claudeChoice: 'Choix de Claude',
                aboutAnthropic: 'À propos d\'Anthropic',
                usagePolicy: 'Politique d\'utilisation',
                privacyPolicy: 'Politique de confidentialité',
                privacyChoices: 'Vos choix de confidentialité',
                keyboardShortcuts: 'Raccourcis clavier',
                upgrade: 'Améliorer',
                uploadFile: 'Télécharger un fichier',
                takeScreenshot: 'Prendre une capture d\'écran',
                addFromGithub: 'Ajouter depuis GitHub',
                useProject: 'Utiliser un projet'
            },
            'de': {
                logoText: 'Claude',
                newChat: 'Neuer Chat',
                chats: 'Chats',
                projects: 'Projekte',
                artifacts: 'Artefakte',
                recents: 'Neueste',
                personal: 'Persönlich',
                freePlan: 'Kostenloser Plan',
                settings: 'Einstellungen',
                language: 'Sprache',
                getHelp: 'Hilfe erhalten',
                upgradePlan: 'Plan upgraden',
                learnMore: 'Mehr erfahren',
                logOut: 'Abmelden',
                welcomeTitle: `${getGreetingText('de')}, yuqingwei`,
                inputPlaceholder: 'Wie kann ich Ihnen heute helfen?',
                code: 'Code',
                write: 'Schreiben',
                learn: 'Lernen',
                lifeStuff: 'Alltag',
                claudeChoice: 'Claudes Wahl',
                aboutAnthropic: 'Über Anthropic',
                usagePolicy: 'Nutzungsrichtlinien',
                privacyPolicy: 'Datenschutzrichtlinie',
                privacyChoices: 'Ihre Datenschutzoptionen',
                keyboardShortcuts: 'Tastenkombinationen',
                upgrade: 'Upgrade',
                uploadFile: 'Datei hochladen',
                takeScreenshot: 'Screenshot aufnehmen',
                addFromGithub: 'Von GitHub hinzufügen',
                useProject: 'Projekt verwenden'
            },
            'es': {
                logoText: 'Claude',
                newChat: 'Nueva conversación',
                chats: 'Conversaciones',
                projects: 'Proyectos',
                artifacts: 'Artefactos',
                recents: 'Recientes',
                personal: 'Personal',
                freePlan: 'Plan gratuito',
                settings: 'Configuración',
                language: 'Idioma',
                getHelp: 'Obtener ayuda',
                upgradePlan: 'Actualizar plan',
                learnMore: 'Saber más',
                logOut: 'Cerrar sesión',
                welcomeTitle: `${getGreetingText('es')}, yuqingwei`,
                inputPlaceholder: '¿Cómo puedo ayudarte hoy?',
                code: 'Código',
                write: 'Escribir',
                learn: 'Aprender',
                lifeStuff: 'Vida cotidiana',
                claudeChoice: 'Elección de Claude',
                aboutAnthropic: 'Acerca de Anthropic',
                usagePolicy: 'Política de uso',
                privacyPolicy: 'Política de privacidad',
                privacyChoices: 'Tus opciones de privacidad',
                keyboardShortcuts: 'Atajos de teclado',
                upgrade: 'Actualizar',
                uploadFile: 'Subir archivo',
                takeScreenshot: 'Tomar captura',
                addFromGithub: 'Agregar desde GitHub',
                useProject: 'Usar proyecto'
            },
            'ja': {
                logoText: 'Claude',
                newChat: '新しいチャット',
                chats: 'チャット',
                projects: 'プロジェクト',
                artifacts: 'アーティファクト',
                recents: '最近',
                personal: '個人',
                freePlan: '無料プラン',
                settings: '設定',
                language: '言語',
                getHelp: 'ヘルプ',
                upgradePlan: 'プランをアップグレード',
                learnMore: '詳細',
                logOut: 'ログアウト',
                welcomeTitle: `${getGreetingText('ja')}、yuqingwei`,
                inputPlaceholder: '今日はどのようなお手伝いができますか？',
                code: 'コード',
                write: '書く',
                learn: '学ぶ',
                lifeStuff: '日常',
                claudeChoice: 'Claude のおすすめ',
                aboutAnthropic: 'Anthropic について',
                usagePolicy: '利用規約',
                privacyPolicy: 'プライバシーポリシー',
                privacyChoices: 'プライバシーの選択',
                keyboardShortcuts: 'キーボードショートカット',
                upgrade: 'アップグレード',
                uploadFile: 'ファイルをアップロード',
                takeScreenshot: 'スクリーンショット',
                addFromGithub: 'GitHub から追加',
                useProject: 'プロジェクトを使用'
            }
        };

        // 语言代码映射
        const languageMap = {
            'English (United States)': 'en',
            '简体中文 (中国)': 'zh',
            'Français (France)': 'fr',
            'Deutsch (Deutschland)': 'de',
            'हिंदी (भारत)': 'en', // 暂时映射到英语
            'Indonesia (Indonesia)': 'en',
            'Italiano (Italia)': 'en',
            '日本語 (日本)': 'ja',
            '한국어(대한민국)': 'en',
            'Português (Brasil)': 'en',
            'Español (Latinoamérica)': 'es',
            'Español (España)': 'es'
        };

        // 检测浏览器语言
        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            console.log('🌍 Browser language detected:', browserLang);
            
            // 将浏览器语言代码映射到我们支持的语言
            if (browserLang.startsWith('zh')) {
                return 'zh'; // 中文
            } else if (browserLang.startsWith('ja')) {
                return 'ja'; // 日语
            } else if (browserLang.startsWith('ko')) {
                return 'en'; // 韩语（暂时映射到英语）
            } else if (browserLang.startsWith('fr')) {
                return 'fr'; // 法语
            } else if (browserLang.startsWith('de')) {
                return 'de'; // 德语
            } else if (browserLang.startsWith('es')) {
                return 'es'; // 西班牙语
            } else if (browserLang.startsWith('pt')) {
                return 'en'; // 葡萄牙语（暂时映射到英语）
            } else if (browserLang.startsWith('it')) {
                return 'en'; // 意大利语（暂时映射到英语）
            } else if (browserLang.startsWith('hi')) {
                return 'en'; // 印地语（暂时映射到英语）
            } else {
                return 'en'; // 默认英语
            }
        }

        // 获取当前语言（优先使用保存的语言，否则自动检测）
        let currentLanguage = localStorage.getItem('preferredLanguage');
        
        // 如果没有保存的语言设置，自动检测浏览器语言
        if (!currentLanguage) {
            currentLanguage = detectBrowserLanguage();
            console.log('✅ Auto-detected language:', currentLanguage);
        } else {
            console.log('✅ Using saved language:', currentLanguage);
        }

        // 应用翻译
        function applyTranslation(lang) {
            const t = translations[lang] || translations['en'];
            
            // 特殊处理：更新问候语
            const welcomeTitleEl = document.getElementById('welcomeTitle');
            if (welcomeTitleEl) {
                const svg = welcomeTitleEl.querySelector('svg');
                const greetingText = getGreetingText(lang) + ', yuqingwei';
                
                // 清除所有文本节点
                Array.from(welcomeTitleEl.childNodes).forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE || node.nodeType === Node.COMMENT_NODE) {
                        welcomeTitleEl.removeChild(node);
                    }
                });
                
                // 添加问候语文本
                welcomeTitleEl.appendChild(document.createTextNode('\n                    ' + greetingText + '\n                '));
            }
            
            // 更新所有文本
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                
                // 跳过 welcomeTitle，已经特殊处理
                if (key === 'welcomeTitle') return;
                
                if (t[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = t[key];
                    } else {
                        // 保留内部的 HTML 结构（如图标和按钮）
                        const children = Array.from(el.childNodes);
                        
                        // 查找并更新纯文本节点
                        let foundTextNode = false;
                        children.forEach(node => {
                            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                                node.textContent = ' ' + t[key];
                                foundTextNode = true;
                            }
                        });
                        
                        // 如果没有找到文本节点，直接设置文本内容
                        if (!foundTextNode) {
                            const hasChildren = children.some(node => node.nodeType === Node.ELEMENT_NODE);
                            if (!hasChildren) {
                                el.textContent = t[key];
                            }
                        }
                    }
                }
            });
            
            // 保存语言选择
            localStorage.setItem('preferredLanguage', lang);
            currentLanguage = lang;
            
            console.log('✅ Language changed to:', lang);
        }

        // Toggle sidebar
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');

        function toggleSidebar() {
            // 移动端使用 mobile-visible 类，桌面端使用 hidden 类
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-visible');
                sidebarBackdrop.classList.toggle('active');
                
                // Prevent body scroll when sidebar is open on mobile
                if (sidebar.classList.contains('mobile-visible')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            } else {
                sidebar.classList.toggle('hidden');
                // 记录用户是否手动收起了侧边栏（桌面端）
                sidebarManuallyHidden = sidebar.classList.contains('hidden');
                
                // 调试日志
                console.log('🔄 Sidebar toggled:', {
                    hidden: sidebarManuallyHidden,
                    windowWidth: window.innerWidth,
                    welcomeSection: document.querySelector('.welcome-section'),
                    welcomeWidth: document.querySelector('.welcome-section')?.offsetWidth,
                    welcomeMaxWidth: window.getComputedStyle(document.querySelector('.welcome-section'))?.maxWidth
                });
            }
        }

        toggleBtn.addEventListener('click', toggleSidebar);

        // Close sidebar when clicking backdrop
        sidebarBackdrop.addEventListener('click', toggleSidebar);

        // Keyboard shortcut for sidebar toggle
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '.') {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Handle window resize
        let sidebarManuallyHidden = false; // 记录用户是否手动收起了侧边栏
        
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.body.style.overflow = '';
                sidebarBackdrop.classList.remove('active');
                // 只有在用户没有手动收起侧边栏时才自动显示
                if (!sidebarManuallyHidden) {
                    sidebar.classList.remove('hidden');
                }
            }
        });

        // Initialize sidebar state on mobile
        if (window.innerWidth <= 768) {
            sidebar.classList.add('hidden');
        }

        // Auto-resize textarea
        const textarea = document.querySelector('.input-box');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 192) + 'px';
        });

        // Send message on Enter (but allow Shift+Enter for new line)
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send button click
        document.querySelector('.send-btn').addEventListener('click', sendMessage);

        // 当前对话 ID
        let currentConversationId = 'conv-' + Date.now();
        let currentModel = 'sonnet-4.5';
        let currentProvider = 'claude'; // 默认使用 Claude
        let isStreaming = false;
        let currentConversationMessages = []; // 当前对话的消息历史
        let conversationTitle = ''; // 当前对话标题

        // ==================== 对话历史管理 ====================
        
        // 保存对话到历史
        function saveConversationToHistory() {
            console.log('💾 saveConversationToHistory called');
            console.log('  currentConversationMessages:', currentConversationMessages.length, 'messages');
            console.log('  currentConversationId:', currentConversationId);
            
            if (currentConversationMessages.length === 0) {
                console.log('⚠️ No messages to save');
                return;
            }

            // 生成对话标题（使用第一条用户消息的前30个字符）
            const firstUserMessage = currentConversationMessages.find(msg => msg.role === 'user');
            console.log('  firstUserMessage:', firstUserMessage?.content?.substring(0, 50));
            
            const title = firstUserMessage 
                ? (firstUserMessage.content.substring(0, 30) + (firstUserMessage.content.length > 30 ? '...' : ''))
                : 'Untitled conversation';

            console.log('  title:', title);

            const conversation = {
                id: currentConversationId,
                title: title,
                messages: currentConversationMessages,
                timestamp: Date.now(),
                model: currentModel
            };

            // 从 localStorage 读取现有历史，确保始终是数组
            let history;
            try {
                const stored = localStorage.getItem('conversationHistory');
                history = stored ? JSON.parse(stored) : [];
                // 确保是数组
                if (!Array.isArray(history)) {
                    console.warn('⚠️ Invalid history data, resetting to empty array');
                    history = [];
                }
            } catch (e) {
                console.error('❌ Failed to parse history:', e);
                history = [];
            }
            
            console.log('  existing history:', history.length, 'conversations');
            
            // 检查是否已存在该对话
            const existingIndex = history.findIndex(conv => conv.id === currentConversationId);
            if (existingIndex >= 0) {
                // 更新现有对话
                console.log('  📝 Updating existing conversation at index', existingIndex);
                history[existingIndex] = conversation;
            } else {
                // 添加新对话到开头
                console.log('  ➕ Adding new conversation');
                history.unshift(conversation);
            }

            // 只保留最近20个对话
            history = history.slice(0, 20);

            // 保存到 localStorage
            try {
                localStorage.setItem('conversationHistory', JSON.stringify(history));
                console.log('  💾 Saved to localStorage');
            } catch (e) {
                console.error('❌ Failed to save to localStorage:', e);
            }
            
            console.log('✅ Conversation saved:', title);
            console.log('  Total conversations in history:', history.length);
            
            // 更新 Recents 列表
            renderRecentsList();
        }

        // 加载对话
        function loadConversation(conversationId) {
            console.log('🔄 loadConversation called, ID:', conversationId);
            
            let history;
            try {
                const stored = localStorage.getItem('conversationHistory');
                history = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(history)) {
                    history = [];
                }
            } catch (e) {
                console.error('❌ Failed to parse history:', e);
                history = [];
            }
            
            const conversation = history.find(conv => conv.id === conversationId);
            
            if (!conversation) {
                console.error('❌ Conversation not found:', conversationId);
                alert('对话历史加载失败，可能已被删除');
                return;
            }

            console.log('📂 Loading conversation:', conversation.title);
            console.log('  Messages count:', conversation.messages?.length || 0);

            // 保存当前对话（如果有消息）
            if (currentConversationMessages.length > 0) {
                console.log('💾 Saving current conversation before switch');
                saveConversationToHistory();
            }

            // 切换到新对话
            currentConversationId = conversation.id;
            currentConversationMessages = conversation.messages || [];
            currentModel = conversation.model || 'sonnet-4.5';

            console.log('  Switched to conversation, messages:', currentConversationMessages.length);

            // 清除当前界面
            const messagesContainer = document.querySelector('.messages-container');
            if (messagesContainer) {
                console.log('  Removing old messages container');
                messagesContainer.remove();
            }

            // 确保输入框在正确的位置
            const chatContainer = document.querySelector('.chat-container');
            const inputSection = document.querySelector('.input-section');
            const welcomeSection = document.querySelector('.welcome-section');
            
            console.log('Elements found:', {
                chatContainer: !!chatContainer,
                inputSection: !!inputSection,
                welcomeSection: !!welcomeSection
            });

            if (!chatContainer || !inputSection) {
                console.error('❌ Required elements not found!');
                return;
            }

            // 隐藏欢迎界面
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
                console.log('  Welcome section hidden');
            }
            
            // 确保输入框在chatContainer中
            if (inputSection.parentElement !== chatContainer) {
                console.log('  Moving input section to chat container');
                chatContainer.appendChild(inputSection);
            }

            // 创建新的消息容器
            const newMessagesContainer = document.createElement('div');
            newMessagesContainer.className = 'messages-container';
            newMessagesContainer.style.cssText = `
                flex: 1;
                overflow-y: auto;
                padding: 2rem;
                max-width: 48rem;
                width: 100%;
                margin: 0 auto;
            `;
            
            chatContainer.insertBefore(newMessagesContainer, inputSection);
            console.log('  New messages container created');

            // 重新渲染消息（不保存到历史，因为已经在历史中）
            console.log('  Rendering', currentConversationMessages.length, 'messages');
            currentConversationMessages.forEach((msg, index) => {
                console.log(`    Message ${index + 1}:`, msg.role, msg.content.substring(0, 50) + '...');
                addMessage(msg.content, msg.role, false, false);
            });

            // 滚动到底部
            setTimeout(() => {
                newMessagesContainer.scrollTop = newMessagesContainer.scrollHeight;
            }, 100);

            // 更新 Recents 列表高亮
            renderRecentsList();

            console.log('✅ Conversation loaded successfully!');
        }

        // 渲染 Recents 列表
        function renderRecentsList() {
            console.log('📋 renderRecentsList called');
            const recentsList = document.getElementById('recentsList');
            if (!recentsList) {
                console.error('❌ recentsList element not found!');
                return;
            }

            let history;
            try {
                const stored = localStorage.getItem('conversationHistory');
                history = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(history)) {
                    console.warn('⚠️ Invalid history data, resetting');
                    history = [];
                }
            } catch (e) {
                console.error('❌ Failed to parse history:', e);
                history = [];
            }
            console.log('  history from localStorage:', history.length, 'conversations');
            
            recentsList.innerHTML = '';

            if (history.length === 0) {
                // 显示空状态提示
                console.log('  📭 No conversations, showing empty hint');
                const emptyHint = document.createElement('div');
                emptyHint.style.cssText = `
                    padding: 0.75rem;
                    color: var(--text-400);
                    font-size: 0.8125rem;
                    text-align: center;
                `;
                emptyHint.textContent = 'No recent conversations';
                recentsList.appendChild(emptyHint);
                return;
            }

            // 渲染对话列表
            console.log('  📝 Rendering', history.length, 'conversations');
            history.forEach(conversation => {
                const item = document.createElement('div');
                item.className = 'recent-item';
                item.textContent = conversation.title;
                item.title = conversation.title; // 完整标题作为 tooltip
                
                // 高亮当前对话
                if (conversation.id === currentConversationId) {
                    item.style.backgroundColor = 'var(--bg-100)';
                    item.style.fontWeight = '500';
                    console.log('  ⭐ Highlighting current conversation:', conversation.title);
                }

                item.addEventListener('click', () => {
                    loadConversation(conversation.id);
                });

                recentsList.appendChild(item);
            });

            console.log('✅ Recents list updated:', history.length, 'conversations');
        }

        // 从配置读取可用的 AI 提供商
        function loadAISettings() {
            const settings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
            return settings.providers || {};
        }

        // 根据模型名称确定提供商和配置
        function getProviderConfig(modelName) {
            console.log('getProviderConfig called with:', modelName);
            
            // Kimi AI - 使用服务器端配置
            if (modelName === 'kimi' || modelName.includes('kimi') || modelName.includes('moonshot')) {
                return {
                    provider: 'custom',
                    config: {
                        model: 'moonshot-v1-8k',
                        stream: true
                    }
                };
            }
            
            // OpenAI models
            if (modelName.includes('gpt') || modelName.includes('chatgpt')) {
                return {
                    provider: 'openai',
                    config: {
                        model: modelName,
                        stream: true
                    }
                };
            }
            
            // Google Gemini
            if (modelName.includes('gemini')) {
                return {
                    provider: 'gemini',
                    config: {
                        model: modelName,
                        stream: true
                    }
                };
            }
            
            // Claude models (default)
            return {
                provider: 'claude',
                config: {
                    model: modelName.includes('sonnet') || modelName.includes('opus') || modelName.includes('haiku') 
                        ? mapClaudeModel(modelName) 
                        : 'claude-3-5-sonnet-20241022',
                    stream: true
                }
            };
        }

        // 映射模型名称到API模型ID
        function mapClaudeModel(modelName) {
            const modelMap = {
                'sonnet-4.5': 'claude-3-5-sonnet-20241022',
                'sonnet-4': 'claude-3-5-sonnet-20241022',
                'opus-4.1': 'claude-opus-4-20241022',
                'opus-4': 'claude-opus-4-20241022',
                'sonnet-3.7': 'claude-3-7-sonnet-20250219',
                'opus-3': 'claude-3-opus-20240229',
                'haiku-3.5': 'claude-3-5-haiku-20241022'
            };
            return modelMap[modelName] || 'claude-3-5-sonnet-20241022';
        }

        // 发送消息函数
        async function sendMessage() {
            console.log('=== sendMessage called ===');
            console.log('currentModel:', currentModel);
            
            const message = textarea.value.trim();
            if (!message || isStreaming) {
                console.log('❌ Cannot send: message empty or already streaming');
                return;
            }

            let messageElement = null;
            let thinkingLoader = null;

            try {
                console.log('✅ Adding user message to UI...');
                // 添加用户消息到界面（保存到历史）
                addMessage(message, 'user', false, true);
                console.log('✅ User message added');
                
                // 清空输入框
                textarea.value = '';
                textarea.style.height = 'auto';

                // 设置为流式请求状态
                isStreaming = true;

                // 获取当前选择的提供商和配置
                console.log('🔍 Getting provider config for:', currentModel);
                const providerData = getProviderConfig(currentModel);
                console.log('✅ Provider data:', providerData);
                
                if (!providerData) {
                    console.error('❌ No provider data returned!');
                    addMessage('❌ 错误：无法识别的模型类型', 'assistant', true);
                    isStreaming = false;
                    return;
                }
                
                const { provider, config } = providerData;
                
                // 构建消息内容（包含文件）
                let fullMessage = message;
                let hasImages = false;
                
                if (uploadedFiles.length > 0) {
                    console.log('📎 Including', uploadedFiles.length, 'file(s) in message');
                    fullMessage += '\n\n---\n**Attached Files:**\n';
                    
                    for (const file of uploadedFiles) {
                        fullMessage += `\n### ${file.name}\n`;
                        if (typeof file.content === 'string' && !file.content.startsWith('data:image')) {
                            // 文本文件：直接附加内容
                            fullMessage += `\`\`\`\n${file.content}\n\`\`\`\n`;
                        } else if (file.type.startsWith('image/')) {
                            // 图片文件：包含 base64 数据让 AI 分析
                            hasImages = true;
                            fullMessage += `\n**[图片数据]**\n`;
                            fullMessage += `![${file.name}](${file.content})\n`;
                            fullMessage += `\n请分析这张图片并回答我的问题。\n`;
                        } else {
                            fullMessage += `[File: ${file.name}, ${formatFileSize(file.size)}]\n`;
                        }
                    }
                    
                    if (hasImages) {
                        fullMessage += '\n\n💡 提示：AI 已收到图片数据，请描述图片内容或回答相关问题。\n';
                    }
                }
                
                console.log('📤 Sending request:');
                console.log('  Provider:', provider);
                console.log('  Config:', config);
                console.log('  Message:', message);
                console.log('  Files:', uploadedFiles.length);
                
                // 调用流式 API
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: fullMessage,
                        conversationId: currentConversationId,
                        provider: provider,
                        config: config
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: 服务器请求失败`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';

                // 立即显示"正在思考"状态
                messageElement = addMessage('', 'assistant', false, false);
                const textElement = messageElement.querySelector('.message-text');
                thinkingLoader = document.createElement('div');
                thinkingLoader.className = 'thinking-loading';
                thinkingLoader.innerHTML = `
                    <svg class="thinking-loading-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <span class="thinking-loading-text">正在思考<span class="thinking-loading-dots">...</span></span>
                `;
                textElement.appendChild(thinkingLoader);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'text') {
                                    assistantMessage += data.content;
                                    
                                    // 移除"正在思考"状态（首次收到内容时）
                                    if (thinkingLoader) {
                                        thinkingLoader.remove();
                                        thinkingLoader = null;
                                    }
                                    
                                    // 更新消息内容（支持思考链）
                                    updateMessageWithThinking(textElement, assistantMessage, provider);
                                    
                                    // 滚动到底部
                                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                                    
                                    // 实时检测代码块并打开 Artifacts
                                    if (assistantMessage.includes('```')) {
                                        window.detectAndOpenArtifacts(assistantMessage);
                                    }
                                } else if (data.type === 'error') {
                                    console.error('Stream error:', data.content);
                                    // 移除加载状态
                                    if (thinkingLoader) {
                                        thinkingLoader.remove();
                                        thinkingLoader = null;
                                    }
                                    if (messageElement) {
                                        textElement.textContent = 'Error: ' + data.content;
                                    } else {
                                        addMessage('Error: ' + data.content, 'assistant', true);
                                    }
                                } else if (data.type === 'end') {
                                    console.log('Stream ended');
                                    // 流式接收完成，保存完整的 assistant 消息到历史
                                    if (assistantMessage.trim()) {
                                        currentConversationMessages.push({
                                            role: 'assistant',
                                            content: assistantMessage,
                                            timestamp: Date.now()
                                        });
                                    }
                                    // 保存对话到历史
                                    saveConversationToHistory();
                                    
                                    // 检测并打开 Artifacts
                                    window.detectAndOpenArtifacts(assistantMessage);
                                    
                                    // 清空文件附件
                                    uploadedFiles = [];
                                    fileAttachmentsContainer.innerHTML = '';
                                    console.log('🗑️ Files cleared after sending');
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('Error sending message:', error);
                
                // 移除加载状态
                if (thinkingLoader && thinkingLoader.parentNode) {
                    thinkingLoader.remove();
                }
                
                let errorMsg = '❌ 发送失败：' + error.message;
                
                // 根据错误类型提供更友好的提示
                if (error.message.includes('Failed to fetch') || error.message.includes('fetch')) {
                    errorMsg = '❌ 连接失败：无法连接到服务器，请确保后端服务正在运行';
                } else if (error.message.includes('401') || error.message.includes('authentication')) {
                    errorMsg = '❌ 认证失败：API Key 无效，请检查配置';
                } else if (error.message.includes('429')) {
                    errorMsg = '❌ 请求过于频繁：请稍后再试';
                } else if (error.message.includes('insufficient')) {
                    errorMsg = '❌ 余额不足：请充值后再使用';
                } else if (error.message.includes('413')) {
                    errorMsg = '❌ 文件太大：请上传更小的文件或压缩图片后再试';
                }
                
                // 如果已经创建了消息元素，更新其内容；否则创建新的错误消息
                if (messageElement) {
                    const textElement = messageElement.querySelector('.message-text');
                    if (textElement) {
                        textElement.textContent = errorMsg;
                    }
                } else {
                    addMessage(errorMsg, 'assistant', true);
                }
            } finally {
                isStreaming = false;
            }
        }

        // 添加消息到界面
        function addMessage(text, role, isError = false, saveToHistory = true) {
            console.log('📝 addMessage called:', { text: text.substring(0, 50), role, isError });
            
            // 保存消息到对话历史（不保存错误消息，且只在指定时保存）
            if (!isError && text.trim() && saveToHistory) {
                currentConversationMessages.push({
                    role: role,
                    content: text,
                    timestamp: Date.now()
                });
            }
            
            try {
                const welcomeSection = document.querySelector('.welcome-section');
                console.log('welcomeSection:', welcomeSection);
                
                // 如果是第一条消息，隐藏欢迎界面，创建消息容器
                if (welcomeSection && !document.querySelector('.messages-container')) {
                    console.log('✅ First message - hiding welcome section');
                    
                    const chatContainer = document.querySelector('.chat-container');
                    console.log('chatContainer:', chatContainer);
                    
                    if (!chatContainer) {
                        console.error('❌ Chat container not found!');
                        return null;
                    }
                    
                    // ✅ 关键修复：先将 input-section 移到 chat-container 外面
                    let inputSection = document.querySelector('.input-section');
                    console.log('inputSection:', inputSection);
                    console.log('inputSection.parentElement:', inputSection?.parentElement?.className);
                    
                    if (inputSection && inputSection.parentElement === welcomeSection) {
                        console.log('✅ Moving input section out of welcome section');
                        chatContainer.appendChild(inputSection);
                        console.log('✅ Input section moved, new parent:', inputSection.parentElement.className);
                    }
                    
                    // ✅ 然后再隐藏 welcome-section
                    welcomeSection.style.display = 'none';
                    
                    console.log('✅ Creating messages container...');
                    const messagesContainer = document.createElement('div');
                    messagesContainer.className = 'messages-container';
                    messagesContainer.style.cssText = `
                        flex: 1;
                        overflow-y: auto;
                        padding: 2rem;
                        width: 100%;
                    `;
                    
                    // ✅ 改用 insertBefore 配合验证父元素
                    inputSection = document.querySelector('.input-section'); // 重新获取引用
                    console.log('Before insertBefore - inputSection parent:', inputSection?.parentElement?.className);
                    console.log('chatContainer children:', Array.from(chatContainer.children).map(c => c.className));
                    
                    if (inputSection && inputSection.parentElement === chatContainer) {
                        console.log('✅ Inserting messages container before input section');
                        try {
                            chatContainer.insertBefore(messagesContainer, inputSection);
                            console.log('✅ insertBefore succeeded!');
                        } catch (error) {
                            console.error('❌ insertBefore failed:', error);
                            // 如果失败，直接 appendChild
                            chatContainer.appendChild(messagesContainer);
                            console.log('✅ Used appendChild as fallback');
                        }
                    } else {
                        console.log('⚠️ inputSection is not a direct child, using appendChild');
                        chatContainer.appendChild(messagesContainer);
                    }
                    console.log('✅ Messages container created and inserted');
                }
            } catch (error) {
                console.error('❌ Error in addMessage (initial setup):', error);
                console.error('Error stack:', error.stack);
                return null;
            }

            const messagesContainer = document.querySelector('.messages-container');
            console.log('messagesContainer:', messagesContainer);
            
            if (!messagesContainer) {
                console.error('❌ Messages container not found!');
                return null;
            }
            
            console.log('✅ Creating message element...');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            messageDiv.style.cssText = `
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                ${role === 'user' ? 'flex-direction: row-reverse;' : ''}
            `;

            const avatar = document.createElement('div');
            avatar.style.cssText = `
                width: 2rem;
                height: 2rem;
                border-radius: 50%;
                background-color: ${role === 'user' ? '#171717' : '#d97757'};
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 0.875rem;
                flex-shrink: 0;
            `;
            avatar.textContent = role === 'user' ? 'Y' : 'C';

            const messageContent = document.createElement('div');
            messageContent.style.cssText = `
                flex: 1;
                ${role === 'user' ? 'text-align: right;' : ''}
            `;

            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.style.cssText = `
                background-color: ${role === 'user' ? '#f4f4f4' : '#ffffff'};
                padding: 0.875rem 1rem;
                border-radius: 1rem;
                color: var(--text-100);
                line-height: 1.6;
                ${role === 'user' ? 'white-space: pre-wrap;' : ''}
                word-wrap: break-word;
                ${isError ? 'color: #ef4444; border: 1px solid #fecaca;' : ''}
                ${role === 'assistant' ? 'border: 0.5px solid #ebebeb;' : ''}
            `;
            
            // AI消息使用Markdown渲染，用户消息保持纯文本
            if (role === 'assistant' && !isError && typeof marked !== 'undefined') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-text-content';
                contentDiv.innerHTML = marked.parse(text);
                messageText.appendChild(contentDiv);
                // 保存原始Markdown文本用于复制（Claude的做法）
                messageText.setAttribute('data-original-markdown', text);
            } else {
                messageText.textContent = text;
            }

            messageContent.appendChild(messageText);
            
            // 为 assistant 消息添加操作按钮
            if (role === 'assistant' && !isError) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                
                // Copy 按钮（复制Markdown格式，类似Claude）
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn';
                copyBtn.title = '复制内容（Markdown格式）- 粘贴到飞书/Notion等保留格式';
                copyBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                `;
                copyBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Claude的做法：优先复制Markdown原文（如果有），否则复制纯文本
                    const originalMarkdown = messageText.getAttribute('data-original-markdown');
                    const textToCopy = originalMarkdown || messageText.textContent || text;
                    
                    const copyFormat = originalMarkdown ? 'Markdown' : 'Plain Text';
                    console.log(`📋 Copying ${copyFormat}`);
                    console.log('📝 Text length:', textToCopy.length, 'chars');
                    console.log('Preview:', textToCopy.substring(0, 100) + '...');
                    
                    try {
                        // 方法1: 现代 Clipboard API
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(textToCopy);
                            console.log(`✅ ${copyFormat} copied successfully (Clipboard API)`);
                        } else {
                            // 方法2: 传统 execCommand（兼容旧浏览器）
                            // 创建临时textarea只包含纯文本
                            const textarea = document.createElement('textarea');
                            textarea.value = textToCopy; // 只设置value，不设置innerHTML
                            textarea.style.position = 'fixed';
                            textarea.style.top = '0';
                            textarea.style.left = '0';
                            textarea.style.width = '1px';
                            textarea.style.height = '1px';
                            textarea.style.padding = '0';
                            textarea.style.border = 'none';
                            textarea.style.outline = 'none';
                            textarea.style.boxShadow = 'none';
                            textarea.style.background = 'transparent';
                            document.body.appendChild(textarea);
                            textarea.focus();
                            textarea.select();
                            
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textarea);
                            
                            if (successful) {
                                console.log(`✅ ${copyFormat} copied successfully (execCommand)`);
                            } else {
                                throw new Error('execCommand returned false');
                            }
                        }
                        
                        // 视觉反馈 - 显示已复制（类似Claude）
                        copyBtn.classList.add('active');
                        const successMsg = originalMarkdown ? '✅ Markdown已复制！' : '✅ 已复制！';
                        copyBtn.title = successMsg;
                        
                        // 改变图标为对勾
                        copyBtn.innerHTML = `
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        `;
                        
                        setTimeout(() => {
                            copyBtn.classList.remove('active');
                            copyBtn.title = '复制内容（Markdown格式）- 粘贴到飞书/Notion等保留格式';
                            // 恢复原图标
                            copyBtn.innerHTML = `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            `;
                        }, 1500);
                    } catch (err) {
                        console.error('❌ Copy failed:', err);
                        // 最后的备用方案：提示用户手动复制
                        const range = document.createRange();
                        range.selectNode(messageText);
                        window.getSelection().removeAllRanges();
                        window.getSelection().addRange(range);
                        alert('Please press Ctrl+C (or Cmd+C on Mac) to copy the selected text.');
                    }
                });
                
                // Good response 按钮
                const goodBtn = document.createElement('button');
                goodBtn.className = 'message-action-btn';
                goodBtn.title = 'Good response';
                goodBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                    </svg>
                `;
                goodBtn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        badBtn.classList.remove('active');
                    }
                });
                
                // Bad response 按钮
                const badBtn = document.createElement('button');
                badBtn.className = 'message-action-btn';
                badBtn.title = 'Bad response';
                badBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                    </svg>
                `;
                badBtn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        goodBtn.classList.remove('active');
                    }
                });
                
                // Retry 按钮
                const retryBtn = document.createElement('button');
                retryBtn.className = 'message-retry-btn';
                retryBtn.innerHTML = `
                    Retry
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;
                
                // Retry 下拉菜单
                const retryDropdown = document.createElement('div');
                retryDropdown.className = 'retry-dropdown';
                retryDropdown.innerHTML = `
                    <div class="retry-dropdown-item">With no changes</div>
                `;
                retryBtn.appendChild(retryDropdown);
                
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    retryDropdown.classList.toggle('active');
                });
                
                // 点击下拉选项
                retryDropdown.querySelector('.retry-dropdown-item').addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('🔄 Retry with no changes clicked');
                    // TODO: 实现重新生成功能
                    alert('Retry feature coming soon!');
                    retryDropdown.classList.remove('active');
                });
                
                // 点击外部关闭下拉菜单
                document.addEventListener('click', () => {
                    retryDropdown.classList.remove('active');
                });
                
                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(goodBtn);
                actionsDiv.appendChild(badBtn);
                actionsDiv.appendChild(retryBtn);
                
                messageContent.appendChild(actionsDiv);
                
                // 添加免责声明
                const disclaimer = document.createElement('div');
                disclaimer.className = 'message-disclaimer';
                disclaimer.textContent = 'Claude can make mistakes. Please double-check responses.';
                messageContent.appendChild(disclaimer);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);

            // ✅ 自动滚动到底部
            requestAnimationFrame(() => {
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            });

            return messageDiv;
        }

        // Model selector dropdown
        const modelSelectorBtn = document.getElementById('modelSelectorBtn');
        const modelDropdownMenu = document.getElementById('modelDropdownMenu');
        const selectedModelText = document.getElementById('selectedModelText');
        const moreModelsBtn = document.getElementById('moreModelsBtn');
        const moreModelsSubmenu = document.getElementById('moreModelsSubmenu');

        // Toggle dropdown
        if (modelSelectorBtn && modelDropdownMenu) {
            modelSelectorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                modelDropdownMenu.classList.toggle('active');
            });
        }

        // Toggle submenu
        if (moreModelsBtn && moreModelsSubmenu) {
            moreModelsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = moreModelsSubmenu.style.display === 'block';
                moreModelsSubmenu.style.display = isVisible ? 'none' : 'block';
            });
        }

        // Select model
        document.querySelectorAll('.model-option-item').forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                
                try {
                    const modelName = option.querySelector('.model-name').textContent.trim();
                    const modelData = option.dataset.model;
                    
                    console.log('=== Model Selection ===');
                    console.log('Model Name:', modelName);
                    console.log('Model Data:', modelData);
                    
                    // Update selected model display
                    if (selectedModelText) {
                        selectedModelText.textContent = modelName;
                        console.log('✅ Updated display text to:', modelName);
                    }
                    
                    // Update current model
                    currentModel = modelData;
                    console.log('✅ Updated currentModel to:', currentModel);
                    
                    // Update selected state
                    document.querySelectorAll('.model-option-item').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.checkmark')?.remove();
                    });
                    option.classList.add('selected');
                    
                    // Add checkmark to selected option
                    if (!option.querySelector('.checkmark')) {
                        const checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        checkmark.setAttribute('class', 'checkmark');
                        checkmark.setAttribute('viewBox', '0 0 24 24');
                        checkmark.setAttribute('fill', 'none');
                        checkmark.setAttribute('stroke', 'currentColor');
                        checkmark.setAttribute('stroke-width', '2.5');
                        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                        polyline.setAttribute('points', '20 6 9 17 4 12');
                        checkmark.appendChild(polyline);
                        option.querySelector('.model-option-header').appendChild(checkmark);
                    }
                    
                    // Close dropdown
                    if (modelDropdownMenu) {
                        modelDropdownMenu.classList.remove('active');
                    }
                    
                    console.log('======================');
                } catch (error) {
                    console.error('❌ Error in model selection:', error);
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (modelSelectorBtn && modelDropdownMenu && !modelSelectorBtn.closest('.model-selector-wrapper').contains(e.target)) {
                modelDropdownMenu.classList.remove('active');
                if (moreModelsSubmenu) {
                    moreModelsSubmenu.style.display = 'none';
                }
            }
        });

        // User menu dropdown
        const userInfo = document.getElementById('userInfo');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        const languageMenuItem = document.getElementById('languageMenuItem');
        const languageSubmenu = document.getElementById('languageSubmenu');
        const learnMoreMenuItem = document.getElementById('learnMoreMenuItem');
        const learnMoreSubmenu = document.getElementById('learnMoreSubmenu');

        userInfo.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenuDropdown.classList.toggle('active');
            languageSubmenu.classList.remove('active');
            if (learnMoreSubmenu) {
                learnMoreSubmenu.classList.remove('active');
            }
        });

        languageMenuItem.addEventListener('mouseenter', () => {
            languageSubmenu.classList.add('active');
        });

        languageMenuItem.addEventListener('mouseleave', (e) => {
            if (!languageSubmenu.contains(e.relatedTarget)) {
                setTimeout(() => {
                    if (!languageSubmenu.matches(':hover')) {
                        languageSubmenu.classList.remove('active');
                    }
                }, 200);
            }
        });

        languageSubmenu.addEventListener('mouseleave', () => {
            setTimeout(() => {
                if (!languageMenuItem.matches(':hover')) {
                    languageSubmenu.classList.remove('active');
                }
            }, 200);
        });

        // Learn more submenu
        if (learnMoreMenuItem && learnMoreSubmenu) {
            learnMoreMenuItem.addEventListener('mouseenter', () => {
                learnMoreSubmenu.classList.add('active');
            });
            learnMoreMenuItem.addEventListener('mouseleave', (e) => {
                if (!learnMoreSubmenu.contains(e.relatedTarget)) {
                    setTimeout(() => {
                        if (!learnMoreSubmenu.matches(':hover')) {
                            learnMoreSubmenu.classList.remove('active');
                        }
                    }, 200);
                }
            });
            learnMoreSubmenu.addEventListener('mouseleave', () => {
                setTimeout(() => {
                    if (!learnMoreMenuItem.matches(':hover')) {
                        learnMoreSubmenu.classList.remove('active');
                    }
                }, 200);
            });
        }

        // Select language
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 获取语言名称并映射到语言代码
                const languageName = option.textContent.trim();
                const langCode = languageMap[languageName] || 'en';
                
                console.log('=== Language Selection ===');
                console.log('Language Name:', languageName);
                console.log('Language Code:', langCode);
                
                // 应用翻译
                applyTranslation(langCode);
                
                // 更新选中状态
                updateLanguageSelection();
                
                // 关闭菜单
                userMenuDropdown.classList.remove('active');
                languageSubmenu.classList.remove('active');
            });
        });
        
        // 更新语言选择菜单的选中状态
        function updateLanguageSelection() {
            // 根据当前语言代码找到对应的语言名称
            const langName = Object.keys(languageMap).find(key => languageMap[key] === currentLanguage);
            
            if (langName) {
                document.querySelectorAll('.language-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('.checkmark-icon')?.remove();
                    
                    if (opt.textContent.trim() === langName) {
                        opt.classList.add('selected');
                        const checkmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        checkmark.setAttribute('class', 'checkmark-icon');
                        checkmark.setAttribute('viewBox', '0 0 24 24');
                        checkmark.setAttribute('fill', 'none');
                        checkmark.setAttribute('stroke', 'currentColor');
                        checkmark.setAttribute('stroke-width', '2.5');
                        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                        polyline.setAttribute('points', '20 6 9 17 4 12');
                        checkmark.appendChild(polyline);
                        opt.appendChild(checkmark);
                    }
                });
            }
        }

        // 页面加载时应用保存的语言和初始化对话历史
        document.addEventListener('DOMContentLoaded', () => {
            applyTranslation(currentLanguage);
            updateLanguageSelection();
            renderRecentsList(); // 初始化对话历史列表
            console.log('✅ Initial language loaded:', currentLanguage);
            console.log('🌍 Browser language:', navigator.language);
            console.log('📋 Recents list initialized');
        });

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!userInfo.contains(e.target)) {
                userMenuDropdown.classList.remove('active');
                languageSubmenu.classList.remove('active');
                if (learnMoreSubmenu) {
                    learnMoreSubmenu.classList.remove('active');
                }
            }
        });

        // ==================== 文件上传功能 ====================
        const attachBtn = document.getElementById('attachBtn');
        const attachmentMenu = document.getElementById('attachmentMenu');
        const fileInput = document.getElementById('fileInput');
        const fileAttachmentsContainer = document.getElementById('fileAttachmentsContainer');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        
        // 存储上传的文件数据
        let uploadedFiles = [];

        attachBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            attachmentMenu.classList.toggle('active');
        });

        // 点击 "Upload a file" 触发文件选择
        uploadFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
            attachmentMenu.classList.remove('active');
        });

        // 处理文件选择
        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                console.log('📎 File selected:', file.name, file.type, file.size);
                
                // 读取文件内容
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: null,
                    preview: null
                };

                // 根据文件类型处理
                if (file.type.startsWith('image/')) {
                    // 图片文件：读取为 base64
                    fileData.content = await readFileAsDataURL(file);
                    fileData.preview = fileData.content;
                } else if (file.type.startsWith('text/') || 
                          file.name.endsWith('.txt') || 
                          file.name.endsWith('.md') || 
                          file.name.endsWith('.json') ||
                          file.name.endsWith('.csv')) {
                    // 文本文件：读取内容
                    fileData.content = await readFileAsText(file);
                } else {
                    // 其他文件：只保存基本信息
                    fileData.content = `[File: ${file.name}]`;
                }

                uploadedFiles.push(fileData);
                renderFileCard(fileData);
            }

            // 清空 input，允许重新选择相同文件
            fileInput.value = '';
        });

        // 压缩图片（参考 Claude 的实现）
        function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // 计算缩放比例
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                        }
                        
                        // 创建 canvas 进行压缩
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为 base64，根据原始格式选择输出格式
                        const mimeType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                        const compressedDataUrl = canvas.toDataURL(mimeType, quality);
                        
                        console.log(`🖼️ 图片压缩: ${file.name}`);
                        console.log(`  原始大小: ${(file.size / 1024).toFixed(2)} KB`);
                        console.log(`  原始尺寸: ${img.width}x${img.height}`);
                        console.log(`  压缩尺寸: ${width}x${height}`);
                        console.log(`  压缩后: ${(compressedDataUrl.length * 0.75 / 1024).toFixed(2)} KB`);
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 读取文件为 Base64（智能压缩）
        async function readFileAsDataURL(file) {
            // 检查文件大小，如果是图片且大于 500KB，则压缩
            if (file.type.startsWith('image/') && file.size > 500 * 1024) {
                try {
                    return await compressImage(file);
                } catch (error) {
                    console.warn('⚠️ 图片压缩失败，使用原图:', error);
                    // 压缩失败则使用原图
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }
            } else {
                // 小图片或非图片文件直接读取
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        }

        // 读取文件为文本
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // 渲染文件卡片
        function renderFileCard(fileData) {
            const card = document.createElement('div');
            card.className = 'file-card';
            
            // 获取文件扩展名
            const ext = fileData.name.split('.').pop().toUpperCase();
            
            // 计算文件行数（如果是文本）
            let linesCount = '';
            if (typeof fileData.content === 'string' && !fileData.content.startsWith('data:')) {
                const lines = fileData.content.split('\n').length;
                linesCount = `${lines} lines`;
            } else if (fileData.type.startsWith('image/')) {
                linesCount = formatFileSize(fileData.size);
            } else {
                linesCount = formatFileSize(fileData.size);
            }

            card.innerHTML = `
                <div class="file-card-content">
                    <div class="file-card-name">${fileData.name}</div>
                    <div class="file-card-meta">${linesCount}</div>
                    <span class="file-card-badge">${ext}</span>
                    ${fileData.preview ? `<img src="${fileData.preview}" class="file-card-image" alt="${fileData.name}">` : ''}
                </div>
                <button class="file-card-remove" title="Remove file">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;

            // 删除按钮事件
            const removeBtn = card.querySelector('.file-card-remove');
            removeBtn.addEventListener('click', () => {
                const index = uploadedFiles.findIndex(f => f.name === fileData.name);
                if (index > -1) {
                    uploadedFiles.splice(index, 1);
                }
                card.remove();
                console.log('🗑️ File removed:', fileData.name);
            });

            fileAttachmentsContainer.appendChild(card);
            console.log('✅ File card rendered:', fileData.name);
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Handle other attachment options
        document.querySelectorAll('.attachment-item').forEach(item => {
            if (item.id === 'uploadFileBtn') return; // 已经处理过了
            
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const action = item.textContent.trim();
                console.log('Attachment action:', action);
                alert(`${action} feature would be implemented here!`);
                attachmentMenu.classList.remove('active');
            });
        });

        // Close attachment menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!attachBtn.contains(e.target)) {
                attachmentMenu.classList.remove('active');
            }
        });

        // New chat button
        const newChatBtn = document.getElementById('newChatBtn');
        newChatBtn.addEventListener('click', () => {
            console.log('🆕 New chat button clicked');
            
            // 保存当前对话（如果有消息）
            if (currentConversationMessages.length > 0) {
                console.log('💾 Saving current conversation before creating new one');
                saveConversationToHistory();
            }
            
            // 创建新的对话 ID
            currentConversationId = 'conv-' + Date.now();
            currentConversationMessages = []; // 清空消息历史
            
            console.log('✅ New conversation ID:', currentConversationId);
            
            // 清除消息容器
            const messagesContainer = document.querySelector('.messages-container');
            if (messagesContainer) {
                messagesContainer.remove();
                console.log('✅ Messages container removed');
            }
            
            // 获取元素
            const welcomeSection = document.querySelector('.welcome-section');
            const chatContainer = document.querySelector('.chat-container');
            const inputSection = document.querySelector('.input-section');
            
            console.log('Elements found:', {
                welcomeSection: !!welcomeSection,
                chatContainer: !!chatContainer,
                inputSection: !!inputSection
            });
            
            // 如果 input-section 不在 chat-container 中，移回去
            if (inputSection && inputSection.parentElement !== chatContainer) {
                console.log('📌 Moving input section back to chat container');
                chatContainer.appendChild(inputSection);
            }
            
            // 显示欢迎界面
            if (welcomeSection) {
                welcomeSection.style.display = 'flex';
                console.log('✅ Welcome section displayed');
            }
            
            // 滚动到顶部
            if (chatContainer) {
                chatContainer.scrollTop = 0;
            }
            
            // 清空输入框
            textarea.value = '';
            textarea.style.height = 'auto';
            
            // 清空文件附件
            uploadedFiles = [];
            fileAttachmentsContainer.innerHTML = '';
            console.log('🗑️ Files cleared for new conversation');
            
            // 更新 Recents 列表，取消所有高亮
            renderRecentsList();
            
            console.log('✅ New conversation started');
        });

        // ==================== Artifacts 功能 ====================
        const artifactsPanel = document.getElementById('artifactsPanel');
        const artifactsTitle = document.getElementById('artifactsTitle');
        const artifactsContent = document.getElementById('artifactsContent');
        const closeArtifactsBtn = document.getElementById('closeArtifactsBtn');
        const copyArtifactsBtn = document.getElementById('copyArtifactsBtn');
        const mainContent = document.querySelector('.main-content');

        // 关闭 Artifacts
        if (closeArtifactsBtn) {
            closeArtifactsBtn.addEventListener('click', () => {
                if (artifactsPanel) artifactsPanel.classList.remove('active');
                if (mainContent) mainContent.classList.remove('with-artifacts');
                
                // 恢复显示左侧栏（仅桌面端）
                const sidebar = document.getElementById('sidebar');
                if (sidebar && window.innerWidth > 768) {
                    sidebar.classList.remove('hidden');
                    sidebarManuallyHidden = false; // 自动显示侧边栏后，重置标志
                }
                // 移动端保持隐藏，用户需要手动打开
            });
        }

        // 复制 Artifacts 内容
        if (copyArtifactsBtn) {
            copyArtifactsBtn.addEventListener('click', async () => {
            const content = artifactsContent.textContent || artifactsContent.innerText;
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(content);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = content;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                
                copyArtifactsBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                `;
                setTimeout(() => {
                    copyArtifactsBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    `;
                }, 1500);
            } catch (err) {
                console.error('Copy failed:', err);
            }
            });
        }

        // 让 AI 修改 Artifacts
        // 编辑功能已移除
        // const editArtifactsBtn = document.getElementById('editArtifactsBtn');
        const artifactsEditPanel = document.getElementById('artifactsEditPanel');
        const artifactsEditInput = document.getElementById('artifactsEditInput');

        if (artifactsEditInput) {
            artifactsEditInput.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const instruction = artifactsEditInput.value.trim();
                    if (!instruction) return;

                    const currentCode = artifactsContent.textContent || artifactsContent.innerText;
                    const prompt = `请根据以下指令修改代码：\n\n指令：${instruction}\n\n当前代码：\n\`\`\`\n${currentCode}\n\`\`\`\n\n请只返回修改后的完整代码，不要有其他说明。`;

                    artifactsEditInput.value = '';
                    artifactsEditInput.placeholder = 'AI 正在修改中...';
                    artifactsEditInput.disabled = true;

                    try {
                        const providerData = getProviderConfig(currentModel);
                        const { provider, config } = providerData;

                        const response = await fetch('/api/chat/stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: prompt,
                                history: [],
                                provider,
                                config
                            })
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let modifiedCode = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'text') {
                                            modifiedCode += data.content;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }

                        // 提取代码块
                        const codeMatch = modifiedCode.match(/```[\w]*\n([\s\S]*?)\n```/);
                        const finalCode = codeMatch ? codeMatch[1] : modifiedCode;

                        artifactsContent.innerHTML = `<pre class="artifacts-code">${escapeHtml(finalCode)}</pre>`;
                        
                    } catch (error) {
                        console.error('AI modification failed:', error);
                        alert('修改失败，请重试');
                    } finally {
                        artifactsEditInput.placeholder = '告诉 AI 如何修改这段代码...（按 Enter 发送）';
                        artifactsEditInput.disabled = false;
                    }
                }
            });
        }

        // 打开 Artifacts（根据设备类型智能展开）
        function openArtifacts(title, content, type = 'code', autoOpen = true) {
            if (!artifactsTitle || !artifactsContent || !artifactsPanel || !mainContent) {
                console.warn('Artifacts elements not found');
                return;
            }
            
            // 更新Artifacts内容
            artifactsTitle.textContent = title;
            
            if (type === 'code') {
                artifactsContent.innerHTML = `<pre class="artifacts-code">${escapeHtml(content)}</pre>`;
            } else if (type === 'markdown') {
                artifactsContent.innerHTML = `<div class="artifacts-markdown">${content}</div>`;
            } else if (type === 'html') {
                artifactsContent.innerHTML = `<iframe class="artifacts-preview" srcdoc="${escapeHtml(content)}"></iframe>`;
            }
            
            // 🎯 根据设备类型决定是否自动展开
            const shouldAutoOpen = autoOpen && window.DeviceDetector && window.DeviceDetector.isDesktop();
            
            if (shouldAutoOpen) {
                // 桌面端：自动展开
                console.log('💻 桌面端：自动展开 Artifacts 面板');
                artifactsPanel.classList.add('active');
                mainContent.classList.add('with-artifacts');
                
                // 自动收起左侧栏，腾出更多空间给对话区域
                const sidebar = document.getElementById('sidebar');
                if (sidebar && window.innerWidth > 768) {
                    sidebar.classList.add('hidden');
                }
            } else {
                // 手机/平板端：不自动展开，但内容已准备好
                console.log('📱 移动/平板端：Artifacts 内容已准备，等待用户手动打开');
                // 可以显示一个提示按钮让用户知道有Artifacts可查看
                showArtifactsNotification();
            }
        }
        
        // 显示Artifacts可用通知（手机/平板端）
        function showArtifactsNotification() {
            if (window.DeviceDetector && window.DeviceDetector.isMobileOrTablet()) {
                // 创建一个浮动按钮提示用户可以查看Artifacts
                let notification = document.getElementById('artifacts-notification');
                if (!notification) {
                    notification = document.createElement('button');
                    notification.id = 'artifacts-notification';
                    notification.className = 'artifacts-notification-btn';
                    notification.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="13" x2="15" y2="13"></line>
                            <line x1="9" y1="17" x2="13" y2="17"></line>
                        </svg>
                        <span>查看代码</span>
                    `;
                    notification.onclick = () => {
                        artifactsPanel.classList.add('active');
                        mainContent.classList.add('with-artifacts');
                        notification.style.display = 'none';
                    };
                    document.body.appendChild(notification);
                }
                notification.style.display = 'flex';
                
                // 5秒后自动隐藏通知
                setTimeout(() => {
                    if (notification) {
                        notification.style.opacity = '0';
                        setTimeout(() => {
                            if (!artifactsPanel.classList.contains('active')) {
                                notification.style.display = 'none';
                            }
                            notification.style.opacity = '1';
                        }, 300);
                    }
                }, 5000);
            }
        }

        // HTML 转义
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 检测代码块并自动打开 Artifacts
        // 当接收到流式消息时，检测是否包含代码块
        let lastDetectedCode = '';
        window.detectAndOpenArtifacts = function(message) {
            // 匹配代码块 ```language\ncode\n```
            const codeBlockRegex = /```(\w+)?\n([\s\S]+?)```/g;
            const matches = [...message.matchAll(codeBlockRegex)];
            
            if (matches.length > 0) {
                const firstMatch = matches[0];
                const language = firstMatch[1] || 'text';
                const code = firstMatch[2].trim();
                
                // 降低门槛：只要有代码块就打开（至少 3 行）
                if (code.split('\n').length >= 3 && code !== lastDetectedCode) {
                    lastDetectedCode = code;
                    console.log('📝 Opening Artifacts with code:', language);
                    // 格式化语言名称（首字母大写）
                    const displayLanguage = language.charAt(0).toUpperCase() + language.slice(1);
                    openArtifacts(`Code: ${displayLanguage}`, code, 'code');
                }
            }
        };
    </script>
</body>
</html>


